version: 2

models:
  - name: fct_person_clinical_episodes_monthly
    description: 'Person-month level aggregation of clinical condition episodes for trend analysis.

      Simplifies population health monitoring and condition prevalence tracking by providing boolean flags for each condition per person per month.

      Key Features:

      • One row per person-month for actively registered patients

      • Boolean flags for all major clinical conditions

      • New episode indicators for incidence tracking

      • Practice information for geographic analysis

      • Summary metrics for quick filtering

      Purpose: Enables simple trend analysis queries without complex episode logic - just GROUP BY analysis_month and SUM condition flags.'

    columns:
      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: analysis_month
        description: 'Month of analysis (first day of month)'
        tests:
          - not_null

      - name: practice_id
        description: 'Practice where person was registered this month'
        tests:
          - not_null

      - name: has_htn
        description: 'Person had active hypertension episode this month'
        tests:
          - accepted_values:
              values: [0, 1]

      - name: has_dm
        description: 'Person had active diabetes episode this month'
        tests:
          - accepted_values:
              values: [0, 1]

      - name: total_active_conditions
        description: 'Total number of active conditions this person had this month'
        tests:
          - dbt_utils.expression_is_true:
              expression: '>= 0'

    tests:
      # Ensure person-month combinations are unique
      - unique:
          column_name: "person_id || '-' || analysis_month"
      
      
      # Test monthly aggregation logic
      - dbt_utils.expression_is_true:
          expression: 'total_active_conditions = (has_ast + has_copd + has_htn + has_chd + has_af + has_hf + has_pad + has_dm + has_gestdiab + has_ndh + has_dep + has_smi + has_ckd + has_dem + has_ep + has_stia + has_can + has_pc + has_ld + has_frail + has_ra + has_ost + has_nafld + has_fh)'
          name: total_conditions_matches_sum
      
      # Test summary flags consistency
      - dbt_utils.expression_is_true:
          expression: '(has_any_condition = 1 AND total_active_conditions > 0) OR (has_any_condition = 0 AND total_active_conditions = 0)'
          name: has_any_condition_flag_consistent
      
      # Test new episode logic
      - dbt_utils.expression_is_true:
          expression: '(has_any_new_episode = 1 AND total_new_episodes_this_month > 0) OR (has_any_new_episode = 0 AND total_new_episodes_this_month = 0)'
          name: has_any_new_episode_flag_consistent
      
      # Ensure only actively registered patients appear
      - dbt_utils.expression_is_true:
          expression: 'practice_id IS NOT NULL'
          name: all_patients_have_practice