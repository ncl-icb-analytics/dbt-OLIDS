version: 2

models:
  - name: flu_weekly_comparison
    description: 'Year-over-year flu campaign comparison view showing current vs previous campaign performance.

      This view provides week-aligned comparison between current and previous flu campaigns, automatically handling different campaign statuses (active vs completed) and enabling "ahead or behind" analysis.

      Key Features:

      • Week-by-week comparison (Week 1 current vs Week 1 previous)

      • Handles campaign end dates correctly using effective_comparison_date logic

      • Shows absolute and percentage differences in vaccination counts

      • Includes performance indicators and trajectory analysis

      • Supports both in-season and post-season comparisons

      Comparison Logic:

      • Active Campaign: Compares current week position to same week last year

      • Completed Campaign: Compares final totals to final totals

      • Mixed Status: Handles edge cases where campaigns have different completion status

      Use Cases:

      • "Are we ahead of or behind where we were at this point last year?"

      • Weekly performance monitoring during active campaigns

      • Final campaign performance evaluation

      • Practice-level performance benchmarking against previous year

      • Trajectory analysis for mid-campaign course corrections'

    columns:
      - name: week_number
        description: 'Week number within campaign (1-26)'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                max_value: 26

      - name: week_start_date
        description: 'Start date of the week (Monday) for current campaign'
        tests:
          - not_null

      - name: practice_code
        description: 'GP practice code'
        tests:
          - not_null

      - name: practice_name
        description: 'GP practice name'
        tests:
          - not_null

      - name: pcn_name
        description: 'Primary Care Network name'

      - name: practice_neighbourhood
        description: 'Practice neighbourhood'

      - name: practice_borough
        description: 'Practice borough'

      - name: risk_group
        description: 'Risk group breakdown (e.g., Over 65, Diabetes, Total)'
        tests:
          - not_null

      - name: campaign_category
        description: 'Campaign category breakdown (e.g., Age Based, Clinical Condition, All Categories)'
        tests:
          - not_null

      # Current Campaign Metrics
      - name: current_eligible
        description: 'Number of eligible persons in current campaign'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: current_cumulative_vaccinations
        description: 'Cumulative vaccinations in current campaign up to this week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: current_uptake_rate
        description: 'Current campaign uptake rate percentage'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 100

      - name: current_weekly_vaccinations
        description: 'Vaccinations administered this week in current campaign'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      # Previous Season Metrics (same week position, previous campaign)
      - name: previous_season_eligible
        description: 'Number of eligible persons in previous season at same week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: previous_season_cumulative_vaccinations
        description: 'Cumulative vaccinations in previous season at same week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: previous_season_uptake_rate
        description: 'Previous season uptake rate at same week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 100

      - name: previous_season_weekly_vaccinations
        description: 'Vaccinations in same week of previous season'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      # Year-over-year Comparison Metrics
      - name: vaccinations_vs_previous_season
        description: 'Difference in cumulative vaccinations (current - previous season). Positive = ahead, negative = behind'

      - name: uptake_rate_difference_vs_previous_season
        description: 'Difference in uptake rate percentage points (current - previous season)'

      - name: percentage_change_vs_previous_season
        description: 'Percentage change in vaccinations vs previous season'

      - name: position_vs_previous_season
        description: 'Year-over-year position indicator (ahead/behind/equal)'
        tests:
          - accepted_values:
              arguments:
                values: ['AHEAD', 'BEHIND', 'EQUAL']

      - name: uptake_rate_vs_previous_season
        description: 'Year-over-year uptake rate comparison indicator'
        tests:
          - accepted_values:
              arguments:
                values: ['HIGHER', 'LOWER', 'EQUAL']

      # Campaign Context
      - name: campaign_status
        description: 'Status of current campaign'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['ACTIVE', 'COMPLETED', 'FUTURE']

      - name: current_week_position
        description: 'Current week position in active campaign'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                max_value: 26

      - name: comparison_type
        description: 'Type of comparison being made'
        tests:
          - not_null

      - name: current_trajectory
        description: 'Assessment of current trajectory (for active campaigns only)'
        tests:
          - accepted_values:
              arguments:
                values: ['Strong', 'Good', 'On Track', 'Concerning', null]

      # Performance Rankings
      - name: practice_rank_current_week
        description: 'Rank of practice by current week cumulative vaccinations'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1

      - name: practice_rank_vs_previous_season
        description: 'Rank of practice by improvement vs previous season'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1

      # Aggregated Context
      - name: pcn_total_current
        description: 'Total current season vaccinations for this PCN at this week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: pcn_total_previous_season
        description: 'Total previous season vaccinations for this PCN at same week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: borough_total_current
        description: 'Total current season vaccinations for this borough at this week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: borough_total_previous_season
        description: 'Total previous season vaccinations for this borough at same week'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - week_number
              - practice_code
              - risk_group
              - campaign_category
          name: flu_weekly_comparison_unique_week_practice_risk

      - dbt_utils.expression_is_true:
          arguments:
            expression: "current_cumulative_vaccinations <= current_eligible"
          name: flu_weekly_comparison_current_within_eligible

      - dbt_utils.expression_is_true:
          arguments:
            expression: "previous_season_cumulative_vaccinations <= previous_season_eligible"
          name: flu_weekly_comparison_previous_season_within_eligible