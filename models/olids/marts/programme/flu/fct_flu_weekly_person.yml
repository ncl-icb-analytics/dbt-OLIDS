version: 2

models:
  - name: fct_flu_weekly_person
    description: 'Person-level weekly flu vaccination timeseries supporting complex multi-dimensional filtering.

      This table expands the sparse person-week snapshot to provide complete weekly vaccination status for every eligible person, enabling sophisticated PowerBI analysis with any combination of demographic and risk group filters.

      Key Features:

      • Complete person × week × campaign grain with carried-forward vaccination status

      • All demographic dimensions included for complex filtering

      • Individual risk group flags for PowerBI filter combinations

      • Optimised for queries like "diabetic AND over 65 AND high deprivation"

      • Built efficiently from sparse source data using window functions

      PowerBI Use Cases:

      • Multi-dimensional analysis: "Show uptake for diabetic patients over 65 in Tower Hamlets"

      • Risk group combinations: "Compare uptake between single vs multiple risk groups"

      • Demographic segmentation: "Analyse uptake by ethnicity within each age band"

      • Geographic drill-down: "Practice performance for specific patient cohorts"

      Technical Implementation:

      • Expands ~2M sparse records to complete timeline using window functions

      • Clusters by campaign_id, week_number, practice_code for optimal filtering performance

      • Pre-joins demographics to avoid complex joins in PowerBI

      • Handles campaign end dates correctly with effective_end_date logic'

    columns:
      - name: campaign_id
        description: 'Flu campaign identifier'
        tests:
          - not_null

      - name: campaign_name
        description: 'Human-readable campaign name'
        tests:
          - not_null

      - name: person_id
        description: 'Unique person identifier'
        tests:
          - not_null

      - name: week_number
        description: 'Week number within campaign (1-26)'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                max_value: 26

      - name: week_start_date
        description: 'Start date of the week (Monday)'
        tests:
          - not_null

      - name: vaccination_status
        description: 'Current vaccination status (carried forward from last change)'
        tests:
          - not_null

      - name: is_vaccinated
        description: 'Boolean flag indicating current vaccination status'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

      - name: vaccination_occurred_this_week
        description: 'Boolean flag indicating if vaccination occurred this specific week'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

      - name: primary_risk_group
        description: 'Primary eligibility risk group'
        tests:
          - not_null

      # Demographics
      - name: sex
        description: 'Person sex'
        tests:
          - not_null

      - name: age
        description: 'Person age at campaign reference date'
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 120

      - name: age_band_5y
        description: '5-year age bands for analysis'

      - name: age_band_10y
        description: '10-year age bands for analysis'

      - name: ethnicity_category
        description: 'High-level ethnicity category'
        tests:
          - not_null

      - name: main_language
        description: 'Person main language'

      - name: interpreter_needed
        description: 'Boolean flag for interpreter requirement'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      # Geography and Organisation
      - name: practice_code
        description: 'GP practice code'
        tests:
          - not_null

      - name: practice_borough
        description: 'Practice borough'

      - name: lsoa_code_21
        description: 'Lower Super Output Area code (2021)'

      - name: imd_decile_19
        description: 'Index of Multiple Deprivation decile (2019)'
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                max_value: 10

      # Risk Group Flags for PowerBI filtering
      - name: is_age_eligible
        description: 'Eligible based on age criteria'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

      - name: is_clinical_eligible
        description: 'Eligible based on clinical conditions'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

      - name: is_over_65
        description: 'Person is over 65 years old'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: has_diabetes
        description: 'Person has diabetes or Addisons disease'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: has_heart_disease
        description: 'Person has chronic heart disease'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: has_respiratory_disease
        description: 'Person has chronic respiratory disease'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: has_immunosuppression
        description: 'Person has immunosuppression'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: is_pregnant
        description: 'Person is pregnant'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: has_learning_disability
        description: 'Person has learning disability'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: is_health_worker
        description: 'Person is health or social care worker'
        tests:
          - accepted_values:
              arguments:
                values: [true, false]

      - name: campaign_phase
        description: 'Phase of campaign based on week number'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['Early Campaign', 'Peak Campaign', 'Late Campaign', 'End Campaign']

      - name: is_latest_week
        description: 'Boolean flag indicating if this is the latest week with data'
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - campaign_id
              - person_id
              - week_number
          name: fct_flu_weekly_person_unique_person_week

      - dbt_utils.expression_is_true:
          arguments:
            expression: "NOT (vaccination_occurred_this_week = true AND is_vaccinated = false)"
          name: fct_flu_weekly_person_vaccination_logic_consistency