version: 2

models:
  - name: person_month_analysis_base
    description: 'Primary analysis table for population health analytics, combining person-months with demographics and conditions in one fast, queryable table.


      Built from date spine (5-year monthly grain) with temporal joins to SCD2 demographics and condition episodes. Incremental materialization processes only new months for performance.


      Core Components:

      • Person-month grain with active registrations only

      • Point-in-time demographics (age, sex, ethnicity, practice)

      • Condition flags calculated from clinical episodes

      • UK financial year dimensions and date helpers

      • Geographic and practice information


      Refresh Strategy: Incremental (new months only). Periodic full refresh captures late-arriving clinical data.'
    
    config:
      tags: ['daily', 'monthly-full']
    
    columns:
      - name: analysis_month
        description: First day of analysis month
      
      - name: person_id
        description: Unique person identifier
      
      - name: year_number
        description: Year as integer for filtering (e.g., 2024)
      
      - name: month_number
        description: Month as integer for filtering (1-12)
      
      - name: quarter_number
        description: Calendar quarter as integer (1-4)
      
      - name: month_year_label
        description: Readable month-year label (e.g., 'MAR 2024')
      
      - name: financial_year
        description: UK financial year label (e.g., '2023/24')
      
      - name: financial_year_start
        description: Starting year of financial year as integer (e.g., 2023)
      
      - name: financial_quarter
        description: UK financial quarter label (Q1-Q4, where Q1 is Apr-Jun)
      
      - name: financial_quarter_number
        description: UK financial quarter as integer (1-4, where 1 is Apr-Jun)
      
      - name: practice_name
        description: Practice where person was registered this month
      
      - name: age
        description: Person's age at this time point
      
      - name: sex
        description: Person's sex
      
      - name: ethnicity_category
        description: Ethnicity category at this time point
      
      - name: practice_borough
        description: Borough where practice is located
      
      - name: has_htn
        description: Had active hypertension this month (1/0)
      
      - name: has_dm
        description: Had active diabetes this month (1/0)
      
      - name: total_active_conditions
        description: Total number of active conditions this month
    
    tests:
      # Data quality tests
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - person_id
              - analysis_month
      
      # Boolean fields should never be NULL (should be FALSE for no conditions)
      - dbt_utils.not_null_proportion:
          arguments:
            column_name: has_dm
            at_least: 0.99
      
      - dbt_utils.not_null_proportion:
          arguments:
            column_name: has_htn
            at_least: 0.99
      
      - dbt_utils.not_null_proportion:
          arguments:
            column_name: has_ckd
            at_least: 0.99
      
      # All boolean flags should be actual booleans (TRUE/FALSE, not NULL)
      - dbt_utils.expression_is_true:
          arguments:
            expression: "has_dm IS NOT NULL"
      
      - dbt_utils.expression_is_true:
          arguments:
            expression: "has_htn IS NOT NULL"
      
      - dbt_utils.expression_is_true:
          arguments:
            expression: "has_any_condition IS NOT NULL"
      
      # Logical consistency tests
      - dbt_utils.expression_is_true:
          arguments:
            expression: "NOT (has_any_condition = FALSE AND total_active_conditions > 0)"
          name: has_any_condition_consistency
      
      - dbt_utils.expression_is_true:
          arguments:
            expression: "NOT (has_any_condition = TRUE AND total_active_conditions = 0)"
          name: has_any_condition_consistency_reverse
      
      # Financial year consistency
      - dbt_utils.expression_is_true:
          arguments:
            expression: "financial_quarter_number BETWEEN 1 AND 4"
          name: valid_financial_quarter
      
      - dbt_utils.expression_is_true:
          arguments:
            expression: "month_number BETWEEN 1 AND 12"
          name: valid_month_number
      
      # No future months
      - dbt_utils.expression_is_true:
          arguments:
            expression: "analysis_month <= CURRENT_DATE()"
          name: no_future_months
      
      # Practice must exist for active registrations
      - dbt_utils.not_null_proportion:
          arguments:
            column_name: practice_name
            at_least: 0.99
      
      # Demographics consistency
      - dbt_utils.expression_is_true:
          arguments:
            expression: "sex IN ('Male', 'Female', 'Unknown', 'Other')"
          name: valid_sex_values
      
      # Note: Prevalence checks moved to custom SQL test file
      # (Can't use aggregate functions in generic test expressions)