version: 2
models:
  - name: int_blood_pressure_all
    description: 'Event-based blood pressure consolidation: one row per person per date with paired systolic/diastolic values, clinical context flags (Home/ABPM), and rich traceability metadata. Filters implausible values and NULL dates.'
    tests:
      - cluster_ids_exist:
          arguments:
            cluster_ids: ABPM_COD, BP_COD, DIASBP_COD, HOMEAMBBP_COD, HOMEBP_COD, SYSBP_COD
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - person_id
              - clinical_effective_date
    columns:
      - name: person_id
        description: Person identifier
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('int_patient_person_unique')
                field: person_id
      - name: clinical_effective_date
        description: Date of blood pressure measurement
        tests:
          - not_null
      - name: systolic_value
        description: Systolic blood pressure value in mmHg
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 40
                max_value: 350
                inclusive: true
                where: "systolic_value IS NOT NULL"
      - name: diastolic_value
        description: Diastolic blood pressure value in mmHg
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 20
                max_value: 200
                inclusive: true
                where: "diastolic_value IS NOT NULL"
