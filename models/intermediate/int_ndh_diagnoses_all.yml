version: 2

models:
  - name: int_ndh_diagnoses_all
    description: |
      All non-diabetic hyperglycaemia (NDH) diagnosis observations from clinical records.
      Complex register requiring integration with diabetes diagnosis history for eligibility.
      
      QOF Register Logic:
      - NDH/IGT/PRD diagnosis for patients aged 18+
      - Exclusion: Current unresolved diabetes (handled in fact layer)
      - Requires diabetes history integration for eligibility
      - Important for diabetes prevention programmes
      
      Includes ALL persons following intermediate layer principles.
      Use as input for fct_person_ndh_register.sql which applies QOF business rules and diabetes exclusions.
    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          
      - name: observation_id
        description: "Unique observation identifier"
        tests:
          - not_null
          
      - name: clinical_effective_date
        description: "Date of the NDH-related observation"
        tests:
          - not_null
          
      - name: concept_code
        description: "SNOMED concept code for NDH observation"
        tests:
          - not_null
          
      - name: concept_display
        description: "Description of the NDH code"
        tests:
          - not_null
          
      - name: source_cluster_id
        description: "QOF cluster ID for NDH pathway"
        tests:
          - not_null
          - accepted_values:
              values: ['NDH_COD', 'IGT_COD', 'PRD_COD']
              
      - name: is_ndh_diagnosis_code
        description: "Flag indicating non-diabetic hyperglycaemia code (NDH_COD)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_igt_diagnosis_code
        description: "Flag indicating impaired glucose tolerance code (IGT_COD)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_pre_diabetes_diagnosis_code
        description: "Flag indicating pre-diabetes code (PRD_COD)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: earliest_ndh_date
        description: "Earliest NDH diagnosis date for this person"
        
      - name: latest_ndh_date
        description: "Latest NDH diagnosis date for this person"
        
      - name: earliest_igt_date
        description: "Earliest IGT diagnosis date for this person"
        
      - name: latest_igt_date
        description: "Latest IGT diagnosis date for this person"
        
      - name: earliest_pre_diabetes_date
        description: "Earliest pre-diabetes diagnosis date for this person"
        
      - name: latest_pre_diabetes_date
        description: "Latest pre-diabetes diagnosis date for this person"
        
      - name: earliest_multi_ndh_date
        description: "Earliest date across all NDH-related diagnoses for this person"
        
      - name: latest_multi_ndh_date
        description: "Latest date across all NDH-related diagnoses for this person"
        
      - name: has_ndh_diagnosis
        description: "Flag indicating person has NDH diagnosis"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_igt_diagnosis
        description: "Flag indicating person has IGT diagnosis"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_pre_diabetes_diagnosis
        description: "Flag indicating person has pre-diabetes diagnosis"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: all_ndh_concept_codes
        description: "Array of all NDH concept codes for this person"
        
      - name: all_ndh_concept_displays
        description: "Array of all NDH concept displays for this person"
        
      - name: all_igt_concept_codes
        description: "Array of all IGT concept codes for this person"
        
      - name: all_igt_concept_displays
        description: "Array of all IGT concept displays for this person"
        
      - name: all_pre_diabetes_concept_codes
        description: "Array of all pre-diabetes concept codes for this person"
        
      - name: all_pre_diabetes_concept_displays
        description: "Array of all pre-diabetes concept displays for this person" 