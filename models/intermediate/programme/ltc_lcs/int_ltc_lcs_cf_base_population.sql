{{ config(
    materialized='table',
    post_hook=[
        "COMMENT ON TABLE {{ this }} IS 'Intermediate: LTC LCS CF Base Population - Defines reusable base population for Long Term Conditions case finding indicators with appropriate exclusions.

Clinical Purpose:
â€¢ Establishes standardised base population for LTC case finding measures
â€¢ Applies systematic exclusions for patients already in LTC programmes
â€¢ Excludes patients with recent NHS health checks to avoid duplication
â€¢ Provides consistent population denominator for case finding indicators

Data Granularity:
â€¢ One row per eligible person for LTC case finding programmes
â€¢ Excludes patients already in LTC programmes (from fct_person_ltc_summary)
â€¢ Excludes patients with NHS health checks in last 24 months
â€¢ Includes current age information for demographic stratification

Key Features:
â€¢ Reusable base population for multiple LTC case finding indicators
â€¢ Systematic exclusion logic preventing duplicate programme targeting
â€¢ NHS health check lookback period of 24 months
â€¢ Integration with person age and LTC summary data for comprehensive population definition

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
    ]
) }}

-- Intermediate model for LTC LCS CF Base Population
-- Reusable base population for LTC LCS case finding indicators.
-- Excludes patients already in LTC programmes and those with NHS health checks in the last 24 months.

WITH health_checks AS (
    -- Get patients with health checks in last 24 months
    SELECT DISTINCT person_id
    FROM {{ ref('int_ltc_lcs_nhs_health_checks') }}
    WHERE clinical_effective_date >= DATEADD(MONTH, -24, CURRENT_DATE())
)

SELECT DISTINCT
    ltc.person_id,
    age.age
FROM {{ ref('fct_person_ltc_summary') }} AS ltc
INNER JOIN {{ ref('dim_person_age') }} AS age ON ltc.person_id = age.person_id
WHERE ltc.person_id NOT IN (
    -- Exclude patients already in LTC programmes
    SELECT person_id
    FROM {{ ref('int_ltc_lcs_cf_exclusions') }}
)
AND ltc.person_id NOT IN (
    -- Exclude patients with health checks in last 24 months
    SELECT person_id
    FROM health_checks
)
