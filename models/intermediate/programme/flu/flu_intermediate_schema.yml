version: 2
models:
- name: int_flu_age_birth_range_rules
  description: 'Intermediate: Flu Age Birth Range Rules - Processes birth date range eligibility for flu vaccination programme child populations.


    Clinical Purpose:

    • Determines child eligibility based on specific birth date ranges for flu vaccination

    • Supports age-based targeting for child populations aged 2-3 and 4-16 years

    • Ensures accurate campaign-specific date calculations for childhood flu programmes


    Data Granularity:

    • One row per eligible child per campaign rule group

    • Covers children aged 2-3 years (born Sept 2020 - Aug 2022 for 2024-25 campaign)

    • Covers school children aged 4-16 years (Reception to Year 11)

    • Filtered to current campaign configuration


    Key Features:

    • Campaign-configurable birth date ranges for different child age groups

    • Age calculations in both months and years at reference date

    • Integration with flu programme logic and campaign dates

    • Replacement for age birth range functionality in apply_flu_rule macro'

  columns:
  - name: campaign_id
    description: Campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (CHILD_2_3, CHILD_4_16)

    tests:
    - not_null
    - accepted_values:

        values:
        - CHILD_2_3
        - CHILD_4_16
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: birth_date
    description: Person's birth date

    tests:
    - not_null
  - name: birth_start
    description: Start of eligible birth date range
  - name: birth_end
    description: End of eligible birth date range
  - name: age_months
    description: Age in months at reference date
  - name: age_years
    description: Age in years at reference date

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - rule_group_id
      - person_id
      name: unique_age_birth_range_person_rule
- name: int_flu_ckd_hierarchical_eligibility
  description: 'Intermediate: Flu CKD Hierarchical Eligibility - Determines flu vaccination eligibility for patients with chronic kidney disease using hierarchical staging logic.


    Clinical Purpose:

    • Identifies patients with chronic kidney disease who qualify for flu vaccination

    • Implements hierarchical logic prioritising more recent severe CKD stages over general CKD codes

    • Supports clinical targeting for high-risk renal disease patients

    • Ensures evidence-based flu vaccination for CKD patients with appropriate staging


    Data Granularity:

    • One row per eligible person aged 6 months to 65 years with documented CKD

    • Requires CKD diagnosis OR CKD stage 3-5 more recent than any-stage CKD code

    • Filtered to current campaign with qualifying CKD clinical evidence

    • Contains hierarchical evidence selection for patients with multiple CKD records


    Key Features:

    • Multi-path eligibility: CKD diagnosis OR hierarchical stage 3-5 evidence

    • Hierarchical staging logic ensuring severe stages take precedence

    • Age restrictions: 6 months to 65 years at reference date

    • Evidence dating logic to prioritise recent severe CKD stages'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (CKD_GROUP)

    tests:
    - not_null
    - accepted_values:

        values:
        - CKD_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying CKD event

    tests:
    - not_null
  - name: diagnosis_type
    description: Type of CKD diagnosis or staging
  - name: stage_hierarchy_note
    description: Explanation of hierarchical staging logic applied
- name: int_flu_bmi_hierarchical_eligibility
  description: 'Intermediate: Flu BMI Hierarchical Eligibility - Determines flu vaccination eligibility for adults with severe obesity using hierarchical BMI evidence.


    Clinical Purpose:

    • Identifies adults with severe obesity (BMI 40+) who qualify for flu vaccination

    • Implements complex hierarchical logic prioritising most recent and severe obesity evidence

    • Supports clinical targeting for high-risk metabolic disease patients

    • Ensures evidence-based flu vaccination for morbidly obese patients


    Data Granularity:

    • One row per eligible adult aged 18-64 years with severe obesity evidence

    • Requires BMI >= 40 or severe obesity clinical coding

    • Filtered to current campaign with qualifying clinical evidence

    • Contains hierarchical evidence selection for patients with multiple BMI records


    Key Features:

    • Multi-path eligibility: BMI >= 40 values OR severe obesity diagnostic codes

    • Hierarchical logic ensuring most recent and severe evidence takes precedence

    • Age restrictions: 18-64 years (216 months to 65 years)

    • Evidence dating logic to prioritise clinical codes over measured BMI values'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (BMI_GROUP)

    tests:
    - not_null
    - accepted_values:

        values:
        - BMI_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying BMI/obesity event

    tests:
    - not_null
  - name: eligibility_path
    description: Path by which BMI eligibility was determined
  - name: latest_bmi_value
    description: Most recent BMI value
- name: int_flu_pregnancy_hierarchical_eligibility
  description: 'Intermediate: Flu Pregnancy Hierarchical Eligibility - Determines flu vaccination eligibility for pregnant women using hierarchical pregnancy evidence.


    Clinical Purpose:

    • Identifies pregnant women who qualify for flu vaccination based on hierarchical pregnancy evidence

    • Prioritises current pregnancies since campaign start over historical pregnancy status

    • Supports clinical targeting for high-risk maternal and foetal health protection

    • Ensures evidence-based flu vaccination for pregnant women with appropriate timing logic


    Data Granularity:

    • One row per eligible woman aged 12-64 years with documented pregnancy

    • Group 1: Pregnancy since campaign start date (highest priority)

    • Group 2: Latest pregnancy before start where pregnancy is more recent than delivery

    • Filtered to current campaign with qualifying pregnancy evidence


    Key Features:

    • Hierarchical pregnancy logic prioritising current over historical pregnancies

    • Campaign timing logic ensuring pregnancy relevance to flu season

    • Age and sex restrictions: women aged 12-64 years (144 months to 65 years)

    • Evidence dating logic comparing pregnancy vs delivery events for historical cases'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (PREG_GROUP)

    tests:
    - not_null
    - accepted_values:

        values:
        - PREG_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying pregnancy event

    tests:
    - not_null
  - name: eligibility_group
    description: Group by which pregnancy eligibility was determined
  - name: person_sex
    description: Person's sex (should be female for pregnancy)

    tests:
    - accepted_values:

        values:
        - F
        - FEMALE
        - WOMAN
- name: int_flu_remaining_simple_eligibility
  description: 'Intermediate: Flu Remaining Simple Eligibility - Processes remaining single-cluster eligibility rules for specific flu vaccination clinical conditions.


    Clinical Purpose:

    • Evaluates chronic neurological disease eligibility for flu vaccination

    • Processes asplenia and spleen dysfunction eligibility criteria

    • Implements learning disability flu vaccination targeting

    • Complements main simple rules model with specific clinical condition groups


    Data Granularity:

    • One row per eligible person aged 6 months to 65 years per rule group

    • CNS_GROUP: chronic neurological conditions (MS, motor neurone disease)

    • ASPLENIA_GROUP: asplenia or splenic dysfunction

    • LEARNDIS_GROUP: learning disabilities


    Key Features:

    • Single-cluster evaluation per rule group with specific clinical conditions

    • Date qualifier logic: earliest for CNS/asplenia, latest for learning disabilities

    • Age restrictions: 6 months to 65 years at reference date

    • Complements main simple rules model with targeted clinical groups'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier

    tests:
    - not_null
    - accepted_values:

        values:
        - CNS_GROUP
        - ASPLENIA_GROUP
        - LEARNDIS_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying clinical event

    tests:
    - not_null
- name: int_flu_remaining_combination_eligibility
  description: 'Intermediate: Flu Remaining Combination Eligibility - Processes remaining combination eligibility rules requiring multiple conditions with AND/OR logic.


    Clinical Purpose:

    • Implements immunosuppression eligibility using multiple evidence types (diagnosis OR medication OR treatment)

    • Processes respiratory disease eligibility combining asthma and respiratory diagnoses

    • Supports complex clinical targeting for high-risk patients with multiple qualifying pathways

    • Complements main combination rules model with specific immunosuppression and respiratory logic


    Data Granularity:

    • One row per eligible person aged 6 months to 65 years per rule group

    • IMMUNO_GROUP: diagnosis OR medication OR administration OR chemotherapy evidence

    • RESP_GROUP: asthma eligibility OR chronic respiratory disease diagnosis

    • Filtered to current campaign with hierarchical evidence selection


    Key Features:

    • Multi-evidence immunosuppression logic with lookback date constraints

    • Respiratory disease union logic combining asthma and respiratory diagnoses

    • Evidence hierarchy selection using most recent qualifying evidence

    • Age restrictions: 6 months to 65 years at reference date'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier

    tests:
    - not_null
    - accepted_values:

        values:
        - IMMUNO_GROUP
        - RESP_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying clinical event

    tests:
    - not_null
  - name: evidence_type
    description: Type of evidence supporting eligibility
- name: int_flu_carer_exclusion_eligibility
  description: 'Intermediate: Flu Carer Exclusion Eligibility - Determines flu vaccination eligibility for unpaid carers with exclusion logic for those already eligible.


    Clinical Purpose:

    • Identifies unpaid carers aged 5-64 who qualify for flu vaccination

    • Implements exclusion logic to prevent double-counting carers already eligible under clinical risk groups

    • Ensures accurate targeting of additional vulnerable populations not covered by clinical criteria

    • Supports expansion of flu vaccination programme to include social care roles


    Data Granularity:

    • One row per eligible carer aged 5-64 years not already qualifying under clinical conditions

    • Requires latest carer code more recent than any \"not carer\" code

    • Excludes carers already eligible under clinical risk groups, BMI, or pregnancy

    • Filtered to current campaign with qualifying carer status


    Key Features:

    • Hierarchical carer status logic prioritising latest carer vs not-carer codes

    • Comprehensive exclusion logic checking all clinical eligibility paths

    • Age restrictions: 5-64 years (60 months to 65 years)

    • Prevents duplicate eligibility for carers with clinical risk factors'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (CARER_GROUP)

    tests:
    - not_null
    - accepted_values:

        values:
        - CARER_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying carer event

    tests:
    - not_null
  - name: carer_type
    description: Type of carer status
  - name: latest_not_carer_date
    description: Date of latest 'not carer' code (if any)
- name: int_flu_vaccination_status
  description: 'Intermediate: Flu Vaccination Status - Flu vaccination status tracking for programme monitoring and coverage reporting.


    Clinical Purpose:

    • NHS flu vaccination programme status monitoring and coverage reporting

    • Vaccination uptake tracking and campaign effectiveness measurement

    • Identification of vaccinated populations for programme planning

    • LAIV (Live Attenuated Influenza Vaccine) administration tracking


    Data Granularity:

    • One row per person with vaccination status information

    • Includes vaccination received, declined, and LAIV administration

    • Uses campaign-specific date thresholds for status determination


    Key Features:

    • Comprehensive vaccination status tracking (received, declined, LAIV)

    • Campaign-configurable date ranges for status validation

    • Essential for coverage reporting and programme effectiveness monitoring

    • Critical for identifying populations still requiring vaccination'

  columns:
  - name: campaign_id
    description: Campaign identifier

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier

    tests:
    - not_null
    - accepted_values:

        values:
        - FLUVAX_GROUP
        - FLUDECLINED_GROUP
        - LAIV_GROUP
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: event_date
    description: Date of vaccination/decline event

    tests:
    - not_null
  - name: status_type
    description: Type of vaccination status

    tests:
    - accepted_values:

        values:
        - vaccinated
        - laiv_vaccinated
        - declined
- name: int_flu_age_based_rules
  description: 'Intermediate: Flu Age Based Rules - Age threshold eligibility determination for NHS flu vaccination programme.


    Clinical Purpose:

    • NHS flu vaccination programme age-based eligibility calculation

    • OVER65_GROUP population identification and campaign management

    • Age threshold validation against campaign reference dates

    • Foundation for flu vaccination programme coverage and uptake monitoring


    Data Granularity:

    • One row per person meeting age-based eligibility criteria

    • Uses campaign-specific age thresholds and reference dates

    • Includes all patients meeting age criteria for comprehensive programme coverage


    Key Features:

    • Age 65+ eligibility determination for high-risk population

    • Campaign-configurable reference date calculations

    • Essential for flu vaccination programme targeting and coverage reporting

    • Foundation for age-based vaccination prioritisation and resource planning'

  columns:
  - name: campaign_id
    description: Campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (e.g., OVER65_GROUP)

    tests:
    - not_null
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: birth_date
    description: Person's birth date

    tests:
    - not_null
  - name: reference_date
    description: Campaign reference date used for age calculation

    tests:
    - not_null
  - name: age_months
    description: Age in months at reference date
  - name: age_years
    description: Age in years at reference date
  - name: description
    description: Rule description

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - rule_group_id
      - person_id
      name: unique_age_based_person_rule
- name: int_flu_simple_rules
  description: 'Intermediate: Flu Simple Rules - Processes single cluster eligibility rules for flu vaccination programme based on individual clinical conditions.


    Clinical Purpose:

    • Evaluates single clinical condition eligibility rules for flu vaccination

    • Supports chronic disease targeting including heart disease, liver disease, CNS conditions

    • Implements learning disability and immunodeficiency flu vaccination criteria

    • Replaces apply_simple_rule macro functionality with explicit SQL logic


    Data Granularity:

    • One row per eligible person per rule group with single cluster condition

    • Covers CHD, CLD, CNS, asplenia, learning disability, and immunodeficiency groups

    • Filtered to current campaign with age restrictions applied per rule group

    • Contains qualifying event dates based on earliest or latest occurrence criteria


    Key Features:

    • Single cluster evaluation: one clinical condition per rule group

    • Flexible date qualifiers: earliest, latest, latest_since, latest_after

    • Age restrictions applied per rule group from campaign configuration

    • Static configuration to avoid unsafe introspection in macro replacement'

  columns:
  - name: campaign_id
    description: Campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (e.g., CHD_GROUP, LEARNDIS_GROUP)

    tests:
    - not_null
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying clinical event

    tests:
    - not_null
  - name: reference_date
    description: Reference date used for date qualifiers
  - name: description
    description: Rule description
  - name: birth_date
    description: Person's birth date
  - name: age_months
    description: Current age in months
  - name: age_years
    description: Current age in years

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - rule_group_id
      - person_id
      name: unique_simple_rule_person
- name: int_flu_combination_rules
  description: 'Intermediate: Flu Combination Rules - Processes complex combination eligibility rules for flu vaccination programme using AND/OR logic.


    Clinical Purpose:

    • Implements complex combination rules requiring multiple conditions for flu vaccination eligibility

    • Supports asthma diagnosis AND medication/admission combinations

    • Handles respiratory disease OR immunosuppression complex logic

    • Replaces apply_combination_rule macro functionality with explicit SQL logic


    Data Granularity:

    • One row per eligible person per rule group with combination rule logic applied

    • Covers asthma group, respiratory group, and immunosuppression group combinations

    • Filtered to current campaign with age restrictions applied per rule group

    • Contains logic expression evaluation for complex clinical combinations


    Key Features:

    • Multi-condition logic: AST_GROUP (diagnosis AND medication/admission)

    • Union logic: RESP_GROUP (asthma OR respiratory disease)

    • Complex combinations: IMMUNO_GROUP (diagnosis OR medication OR treatment)

    • Age restrictions applied per rule group from campaign configuration'

  columns:
  - name: campaign_id
    description: Campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier (e.g., AST_GROUP, RESP_GROUP)

    tests:
    - not_null
  - name: person_id
    description: Person identifier

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: Date of qualifying clinical event

    tests:
    - not_null
  - name: reference_date
    description: Reference date used for eligibility
  - name: description
    description: Rule description
  - name: birth_date
    description: Person's birth date
  - name: age_months
    description: Current age in months
  - name: age_years
    description: Current age in years

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - rule_group_id
      - person_id
      name: unique_combination_rule_person
- name: int_flu_diabetes_eligibility
  description: 'Intermediate: Flu Diabetes Eligibility - Diabetes and Addison disease eligibility determination for NHS flu vaccination programme.


    Clinical Purpose:

    • NHS flu vaccination programme diabetes and Addison disease eligibility assessment

    • High-risk population identification due to immunocompromise and infection risk

    • Clinical eligibility validation for diabetes and adrenal insufficiency conditions

    • Age-restricted eligibility determination (6 months to under 65 years)


    Data Granularity:

    • One row per person meeting diabetes or Addison disease eligibility criteria

    • Uses hierarchical date logic for active diabetes determination

    • Excludes resolved diabetes using latest diagnosis vs resolution comparison


    Key Features:

    • Active diabetes determination with resolution exclusion logic

    • Addison disease immunocompromise risk assessment

    • Age restriction compliance (6 months to under 65 years)

    • Essential for high-risk population vaccination targeting'

  columns:
  - name: campaign_id
    description: Flu vaccination campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier - always 'DIAB_GROUP' for diabetes/Addison's eligibility

    tests:
    - not_null
    - accepted_values:

        values:
        - DIAB_GROUP
  - name: rule_group_name
    description: Human-readable rule group name - always 'Diabetes'

    tests:
    - not_null
    - accepted_values:

        values:
        - Diabetes
  - name: person_id
    description: Unique person identifier from clinical system

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: 'Date of the clinical event that establishes eligibility: - For Addison''s disease: earliest diagnosis date - For diabetes: latest diabetes diagnosis date (after exclusion logic)'

    tests:
    - not_null
  - name: diagnosis_type
    description: 'Type of qualifying diagnosis: - ''Addison''s disease'' for ADDIS_COD codes - ''Diabetes (type 1 or 2)'' for DIAB_COD codes'

    tests:
    - not_null
    - accepted_values:

        values:
        - Addison's disease
        - Diabetes (type 1 or 2)
  - name: latest_resolved_date
    description: Date of most recent diabetes resolved code (DMRES_COD) if any exists. NULL for Addison's disease cases or when no resolved codes exist. Used in business logic to determine if diabetes is still active.
  - name: reference_date
    description: Campaign reference date used for age calculations and clinical date cutoffs

    tests:
    - not_null
  - name: description
    description: 'Standard description: ''Diabetes (type 1, type 2) or Addison''s disease'''

    tests:
    - not_null
  - name: birth_date
    description: Person's birth date from demographics

    tests:
    - not_null
  - name: age_months_at_ref_date
    description: Age in months at campaign reference date. Used for precise age-based eligibility (minimum 6 months).

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: '>= 6'
        name: diabetes_min_age_6_months
  - name: age_years_at_ref_date
    description: Age in years at campaign reference date. Used for age-based exclusion (must be under 65).

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: < 65
        name: diabetes_max_age_under_65
  - name: created_at
    description: Timestamp when record was created (audit date for campaign)

    tests:
    - not_null

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - person_id
      name: unique_diabetes_eligibility_per_person
  - dbt_utils.expression_is_true:
      expression: qualifying_event_date <= reference_date
      name: diabetes_qualifying_event_before_reference
  - dbt_utils.expression_is_true:
      expression: CASE WHEN latest_resolved_date IS NOT NULL THEN qualifying_event_date > latest_resolved_date ELSE TRUE END
      name: diabetes_active_after_resolution
- name: int_flu_asthma_eligibility
  description: 'Intermediate: Flu Asthma Eligibility - Determines flu vaccination eligibility for patients with asthma using hierarchical clinical evidence.


    Clinical Purpose:

    • Identifies patients with asthma who qualify for flu vaccination based on diagnosis and active management

    • Implements complex business logic requiring both asthma diagnosis and recent management evidence

    • Supports clinical decision-making for high-risk respiratory disease patients

    • Ensures evidence-based flu vaccination targeting for asthma patients


    Data Granularity:

    • One row per eligible person aged 6 months to 65 years with documented asthma

    • Requires both asthma diagnosis and evidence of active management or severity

    • Filtered to current campaign with qualifying clinical evidence

    • Contains hierarchical evidence selection for patients with multiple evidence types


    Key Features:

    • Primary requirement: Asthma diagnosis (AST_COD) with earliest occurrence tracking

    • Secondary requirement: Recent medication OR historical admission evidence

    • Age restrictions: 6 months to 65 years at reference date

    • Evidence hierarchy selection using most recent qualifying evidence'

  columns:
  - name: campaign_id
    description: Campaign identifier (e.g., flu_2024_25)

    tests:
    - not_null
  - name: rule_group_id
    description: Rule group identifier - always 'AST_GROUP' for asthma eligibility

    tests:
    - not_null
    - accepted_values:

        values:
        - AST_GROUP
  - name: rule_group_name
    description: Human-readable rule group name - always 'Asthma'

    tests:
    - not_null
    - accepted_values:

        values:
        - Asthma
  - name: person_id
    description: Person identifier - must exist in demographics table

    tests:
    - not_null
    - relationships:
        to: ref('dim_person_demographics')
        field: person_id
  - name: qualifying_event_date
    description: '**Date of first asthma diagnosis (AST_COD)**

      This represents the earliest recorded asthma diagnosis that establishes

      the patient''s asthma status. This is the primary qualifying event that

      must be present for eligibility consideration.'

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: qualifying_event_date <= reference_date

        config:
          severity: error
          error_if: '>0'
  - name: evidence_date
    description: '**Date of most recent supporting evidence**

      This is the date of the most recent evidence that supports active asthma


      management or severity. Evidence can be:

      - Recent asthma medication (ASTMED_COD/ASTRX_COD) since lookback date

      - Asthma admission (ASTADM_COD) at any time

      When multiple evidence types exist, the most recent date is selected.'

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: evidence_date <= reference_date

        config:
          severity: error
          error_if: '>0'
  - name: evidence_type
    description: '**Type of evidence supporting asthma eligibility**


      Categorizes the evidence that qualified the patient:

      - ''Recent asthma medication'': Medication prescribed/ordered since lookback date

      - ''Asthma admission'': Hospital admission for asthma at any time

      This helps understand the clinical pathway for eligibility.'

    tests:
    - not_null
    - accepted_values:

        values:
        - Recent asthma medication
        - Asthma admission
  - name: reference_date
    description: '**Campaign reference date for age calculations**


      The official reference date for the flu campaign, used for:

      - Age eligibility calculations (6 months to <65 years)

      - Ensuring all clinical events occur before this date'

    tests:
    - not_null
  - name: description
    description: '**Rule description for audit and reporting**


      Standard description explaining the eligibility logic:

      ''Asthma diagnosis with recent medication or admission'''

    tests:
    - not_null
    - accepted_values:

        values:
        - Asthma diagnosis with recent medication or admission
  - name: birth_date
    description: Person's birth date from demographics table

    tests:
    - not_null
  - name: age_months_at_ref_date
    description: '**Age in months at reference date**

      Calculated as DATEDIFF(''month'', birth_date, reference_date).

      Used for precise age-based eligibility filtering (≥6 months).'

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: age_months_at_ref_date >= 6

        config:
          severity: error
          error_if: '>0'
  - name: age_years_at_ref_date
    description: '**Age in years at reference date**

      Calculated as DATEDIFF(''year'', birth_date, reference_date).

      Used for age-based eligibility filtering (<65 years).'

    tests:
    - not_null
    - dbt_utils.expression_is_true:
        expression: age_years_at_ref_date < 65

        config:
          severity: error
          error_if: '>0'
  - name: created_at
    description: Audit timestamp - date when eligibility was determined

    tests:
    - not_null

  tests:
  - dbt_utils.unique_combination_of_columns:

      combination_of_columns:
      - campaign_id
      - rule_group_id
      - person_id
      name: unique_asthma_eligibility_person

      config:
        severity: error
  - dbt_utils.expression_is_true:
      expression: qualifying_event_date <= evidence_date
      name: asthma_diagnosis_before_evidence

      config:
        severity: warn
        error_if: '>10'
  - dbt_utils.not_null_proportion:
      at_least: 0.95
      name: asthma_eligibility_completeness

      config:
        severity: warn
