version: 2

models:
  - name: int_flu_age_birth_range_rules
    description: "Birth date range eligibility rules for child flu vaccination (CHILD_2_3, CHILD_4_16)"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (CHILD_2_3, CHILD_4_16)"
        tests:
          - not_null
          - accepted_values:
              values: ['CHILD_2_3', 'CHILD_4_16']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: birth_date
        description: "Person's birth date"
        tests:
          - not_null
      - name: birth_start
        description: "Start of eligible birth date range"
      - name: birth_end
        description: "End of eligible birth date range"
      - name: age_months
        description: "Age in months at reference date"
      - name: age_years
        description: "Age in years at reference date"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - person_id
          name: unique_age_birth_range_person_rule

  - name: int_flu_ckd_hierarchical_eligibility
    description: "CKD hierarchical eligibility with stage-based logic"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (CKD_GROUP)"
        tests:
          - not_null
          - accepted_values:
              values: ['CKD_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying CKD event"
        tests:
          - not_null
      - name: diagnosis_type
        description: "Type of CKD diagnosis or staging"
      - name: stage_hierarchy_note
        description: "Explanation of hierarchical staging logic applied"

  - name: int_flu_bmi_hierarchical_eligibility
    description: "BMI hierarchical eligibility for severe obesity (BMI 40+)"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (BMI_GROUP)"
        tests:
          - not_null
          - accepted_values:
              values: ['BMI_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying BMI/obesity event"
        tests:
          - not_null
      - name: eligibility_path
        description: "Path by which BMI eligibility was determined"
      - name: latest_bmi_value
        description: "Most recent BMI value"

  - name: int_flu_pregnancy_hierarchical_eligibility
    description: "Pregnancy hierarchical eligibility with delivery logic"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (PREG_GROUP)"
        tests:
          - not_null
          - accepted_values:
              values: ['PREG_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying pregnancy event"
        tests:
          - not_null
      - name: eligibility_group
        description: "Group by which pregnancy eligibility was determined"
      - name: person_sex
        description: "Person's sex (should be female for pregnancy)"
        tests:
          - accepted_values:
              values: ['F', 'FEMALE', 'WOMAN']

  - name: int_flu_remaining_simple_eligibility
    description: "Remaining simple rule groups (CNS, ASPLENIA, LEARNDIS)"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier"
        tests:
          - not_null
          - accepted_values:
              values: ['CNS_GROUP', 'ASPLENIA_GROUP', 'LEARNDIS_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying clinical event"
        tests:
          - not_null

  - name: int_flu_remaining_combination_eligibility
    description: "Remaining combination rule groups (IMMUNO, RESP)"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier"
        tests:
          - not_null
          - accepted_values:
              values: ['IMMUNO_GROUP', 'RESP_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying clinical event"
        tests:
          - not_null
      - name: evidence_type
        description: "Type of evidence supporting eligibility"

  - name: int_flu_carer_exclusion_eligibility
    description: "Carer exclusion eligibility (carers not already eligible under other rules)"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (CARER_GROUP)"
        tests:
          - not_null
          - accepted_values:
              values: ['CARER_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying carer event"
        tests:
          - not_null
      - name: carer_type
        description: "Type of carer status"
      - name: latest_not_carer_date
        description: "Date of latest 'not carer' code (if any)"

  - name: int_flu_vaccination_status
    description: "Vaccination status tracking (given, declined, LAIV)"
    columns:
      - name: campaign_id
        description: "Campaign identifier"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier"
        tests:
          - not_null
          - accepted_values:
              values: ['FLUVAX_GROUP', 'FLUDECLINED_GROUP', 'LAIV_GROUP']
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: event_date
        description: "Date of vaccination/decline event"
        tests:
          - not_null
      - name: status_type
        description: "Type of vaccination status"
        tests:
          - accepted_values:
              values: ['vaccinated', 'laiv_vaccinated', 'declined']
  - name: int_flu_age_based_rules
    description: "Age-based eligibility rules for flu vaccination (e.g., Over 65)"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (e.g., OVER65_GROUP)"
        tests:
          - not_null
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: birth_date
        description: "Person's birth date"
        tests:
          - not_null
      - name: reference_date
        description: "Campaign reference date used for age calculation"
        tests:
          - not_null
      - name: age_months
        description: "Age in months at reference date"
      - name: age_years
        description: "Age in years at reference date"
      - name: description
        description: "Rule description"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - person_id
          name: unique_age_based_person_rule

  - name: int_flu_simple_rules
    description: "Simple single-cluster eligibility rules for flu vaccination"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (e.g., CHD_GROUP, LEARNDIS_GROUP)"
        tests:
          - not_null
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying clinical event"
        tests:
          - not_null
      - name: reference_date
        description: "Reference date used for date qualifiers"
      - name: description
        description: "Rule description"
      - name: birth_date
        description: "Person's birth date"
      - name: age_months
        description: "Current age in months"
      - name: age_years
        description: "Current age in years"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - person_id
          name: unique_simple_rule_person

  - name: int_flu_combination_rules
    description: "Combination eligibility rules requiring multiple conditions (AND/OR logic)"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (e.g., AST_GROUP, RESP_GROUP)"
        tests:
          - not_null
      - name: person_id
        description: "Person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: "Date of qualifying clinical event"
        tests:
          - not_null
      - name: reference_date
        description: "Reference date used for eligibility"
      - name: description
        description: "Rule description"
      - name: birth_date
        description: "Person's birth date"
      - name: age_months
        description: "Current age in months"
      - name: age_years
        description: "Current age in years"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - person_id
          name: unique_combination_rule_person

  - name: int_flu_diabetes_eligibility
    description: >
      Diabetes and Addison's disease eligibility for flu vaccination program.
      
      This model implements complex business logic for diabetes-related flu vaccination eligibility:
      
      **Eligibility Criteria:**
      - **Addison's disease**: Any diagnosis of Addison's disease (ADDIS_COD) - earliest occurrence qualifies
      - **Diabetes**: Type 1 or Type 2 diabetes diagnosis (DIAB_COD) that meets exclusion criteria:
        - Must have a diabetes diagnosis AND either:
          - No diabetes resolved code (DMRES_COD) on record, OR
          - Latest diabetes diagnosis is more recent than latest diabetes resolved code
      
      **Age Restrictions:**
      - Minimum age: 6 months at campaign reference date
      - Maximum age: Under 65 years at campaign reference date
      
      **Clinical Context:**
      Diabetes patients are at higher risk for flu complications due to:
      - Compromised immune system
      - Increased risk of secondary infections
      - Potential for diabetic ketoacidosis triggered by flu
      
      Addison's disease patients are eligible due to:
      - Adrenal insufficiency causing immunocompromise
      - Steroid dependency affecting immune response
      
      **Business Logic Notes:**
      - Uses hierarchical date logic to handle diabetes resolution codes
      - Prioritizes most recent clinical evidence
      - Implements age-based inclusion/exclusion after clinical eligibility
    columns:
      - name: campaign_id
        description: "Flu vaccination campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier - always 'DIAB_GROUP' for diabetes/Addison's eligibility"
        tests:
          - not_null
          - accepted_values:
              values: ['DIAB_GROUP']
      - name: rule_group_name
        description: "Human-readable rule group name - always 'Diabetes'"
        tests:
          - not_null
          - accepted_values:
              values: ['Diabetes']
      - name: person_id
        description: "Unique person identifier from clinical system"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: >
          Date of the clinical event that establishes eligibility:
          - For Addison's disease: earliest diagnosis date
          - For diabetes: latest diabetes diagnosis date (after exclusion logic)
        tests:
          - not_null
      - name: diagnosis_type
        description: >
          Type of qualifying diagnosis:
          - 'Addison's disease' for ADDIS_COD codes
          - 'Diabetes (type 1 or 2)' for DIAB_COD codes
        tests:
          - not_null
          - accepted_values:
              values: ['Addison''s disease', 'Diabetes (type 1 or 2)']
      - name: latest_resolved_date
        description: >
          Date of most recent diabetes resolved code (DMRES_COD) if any exists.
          NULL for Addison's disease cases or when no resolved codes exist.
          Used in business logic to determine if diabetes is still active.
      - name: reference_date
        description: "Campaign reference date used for age calculations and clinical date cutoffs"
        tests:
          - not_null
      - name: description
        description: "Standard description: 'Diabetes (type 1, type 2) or Addison's disease'"
        tests:
          - not_null
      - name: birth_date
        description: "Person's birth date from demographics"
        tests:
          - not_null
      - name: age_months_at_ref_date
        description: >
          Age in months at campaign reference date.
          Used for precise age-based eligibility (minimum 6 months).
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 6"
              name: diabetes_min_age_6_months
      - name: age_years_at_ref_date
        description: >
          Age in years at campaign reference date.
          Used for age-based exclusion (must be under 65).
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "< 65"
              name: diabetes_max_age_under_65
      - name: created_at
        description: "Timestamp when record was created (audit date for campaign)"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - person_id
          name: unique_diabetes_eligibility_per_person
      - dbt_utils.expression_is_true:
          expression: "qualifying_event_date <= reference_date"
          name: diabetes_qualifying_event_before_reference
      - dbt_utils.expression_is_true:
          expression: "CASE WHEN latest_resolved_date IS NOT NULL THEN qualifying_event_date > latest_resolved_date ELSE TRUE END"
          name: diabetes_active_after_resolution

  - name: int_flu_asthma_eligibility
    description: |
      **Asthma Eligibility for Flu Vaccination**
      
      Implements the specific business logic for asthma-related flu vaccination eligibility
      using a combination rule approach. This model identifies patients who are eligible 
      for flu vaccination based on asthma diagnosis combined with evidence of active asthma
      management or severity.
      
      **Business Rules:**
      - **Primary requirement:** Asthma diagnosis (AST_COD) - uses earliest occurrence
      - **Secondary requirement (AND):** One of the following:
        - Recent asthma medication (ASTMED_COD or ASTRX_COD) since specified lookback date
        - OR asthma admission (ASTADM_COD) at any time in history
      
      **Age Restrictions:** 
      - Minimum: 6 months of age at reference date
      - Maximum: Under 65 years of age at reference date
      
      **Evidence Hierarchy:**
      When multiple evidence types exist for the same person, the most recent evidence 
      date is selected to represent the qualifying event.
      
      **Replacement Logic:**
      This model replaces the apply_asthma_combination_rule macro functionality 
      with explicit SQL logic for better maintainability and auditability.
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier - always 'AST_GROUP' for asthma eligibility"
        tests:
          - not_null
          - accepted_values:
              values: ['AST_GROUP']
      - name: rule_group_name
        description: "Human-readable rule group name - always 'Asthma'"
        tests:
          - not_null
          - accepted_values:
              values: ['Asthma']
      - name: person_id
        description: "Person identifier - must exist in demographics table"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: |
          **Date of first asthma diagnosis (AST_COD)**
          
          This represents the earliest recorded asthma diagnosis that establishes
          the patient's asthma status. This is the primary qualifying event that
          must be present for eligibility consideration.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "qualifying_event_date <= reference_date"
              config:
                severity: error
                error_if: ">0"
      - name: evidence_date
        description: |
          **Date of most recent supporting evidence**
          
          This is the date of the most recent evidence that supports active asthma
          management or severity. Evidence can be:
          - Recent asthma medication (ASTMED_COD/ASTRX_COD) since lookback date
          - Asthma admission (ASTADM_COD) at any time
          
          When multiple evidence types exist, the most recent date is selected.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "evidence_date <= reference_date"
              config:
                severity: error
                error_if: ">0"
      - name: evidence_type
        description: |
          **Type of evidence supporting asthma eligibility**
          
          Categorizes the evidence that qualified the patient:
          - 'Recent asthma medication': Medication prescribed/ordered since lookback date
          - 'Asthma admission': Hospital admission for asthma at any time
          
          This helps understand the clinical pathway for eligibility.
        tests:
          - not_null
          - accepted_values:
              values: ['Recent asthma medication', 'Asthma admission']
      - name: reference_date
        description: |
          **Campaign reference date for age calculations**
          
          The official reference date for the flu campaign, used for:
          - Age eligibility calculations (6 months to <65 years)
          - Ensuring all clinical events occur before this date
        tests:
          - not_null
      - name: description
        description: |
          **Rule description for audit and reporting**
          
          Standard description explaining the eligibility logic:
          'Asthma diagnosis with recent medication or admission'
        tests:
          - not_null
          - accepted_values:
              values: ['Asthma diagnosis with recent medication or admission']
      - name: birth_date
        description: "Person's birth date from demographics table"
        tests:
          - not_null
      - name: age_months_at_ref_date
        description: |
          **Age in months at reference date**
          
          Calculated as DATEDIFF('month', birth_date, reference_date).
          Used for precise age-based eligibility filtering (≥6 months).
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "age_months_at_ref_date >= 6"
              config:
                severity: error
                error_if: ">0"
      - name: age_years_at_ref_date
        description: |
          **Age in years at reference date**
          
          Calculated as DATEDIFF('year', birth_date, reference_date).
          Used for age-based eligibility filtering (<65 years).
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "age_years_at_ref_date < 65"
              config:
                severity: error
                error_if: ">0"
      - name: created_at
        description: "Audit timestamp - date when eligibility was determined"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - person_id
          name: unique_asthma_eligibility_person
          config:
            severity: error
      - dbt_utils.expression_is_true:
          expression: "qualifying_event_date <= evidence_date"
          name: asthma_diagnosis_before_evidence
          config:
            severity: warn
            error_if: ">10"  # Allow some tolerance for data quality issues
      - dbt_utils.not_null_proportion:
          at_least: 0.95
          name: asthma_eligibility_completeness
          config:
            severity: warn