{{ config(
    materialized='table',
    description='Intermediate table extracting all psychiatry-related events for each person, using mapped concepts, observation, and valproate program codes (category PSYCH).',
    post_hook=[
        "COMMENT ON TABLE {{ this }} IS 'Intermediate: Valproate Psychiatry Events - Comprehensive collection of all psychiatry-related events for valproate patient safety monitoring.

Clinical Purpose:
â€¢ Gathers all psychiatry specialty events for patients on valproate therapy
â€¢ Supports psychiatry pathway tracking for valproate patient safety monitoring
â€¢ Enables comprehensive monitoring of psychiatric care in valproate safety programme
â€¢ Provides foundation data for valproate programme psychiatry specialty analysis

Data Granularity:
â€¢ One row per psychiatry event observation for patients on valproate therapy
â€¢ Covers all psychiatry-related observations using PSYCH code category
â€¢ Includes clinical effective dates for temporal analysis and psychiatry pathway tracking
â€¢ Contains concept codes and descriptions for detailed psychiatry event documentation

Key Features:
â€¢ PSYCH code category filtering for comprehensive psychiatry event capture
â€¢ Integration with valproate programme codes for psychiatry pathway tracking
â€¢ Support for psychiatry specialty monitoring in valproate safety programme
â€¢ Foundation data for psychiatric care pathway analysis in valproate patients

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
    ]
) }}

SELECT
    pp.person_id,
    o.clinical_effective_date::date AS psych_event_date,
    o.id AS psych_observation_id,
    mc.concept_code AS psych_concept_code,
    mc.code_description AS psych_concept_display,
    vpc.code_category AS psych_code_category
FROM {{ ref('stg_olids_observation') }} AS o
INNER JOIN {{ ref('stg_codesets_mapped_concepts') }} AS mc
    ON o.observation_core_concept_id = mc.source_code_id
INNER JOIN {{ ref('stg_codesets_valproate_prog_codes') }} AS vpc
    ON mc.concept_code = vpc.code
INNER JOIN {{ ref('stg_olids_patient_person') }} AS pp
    ON o.patient_id = pp.patient_id
WHERE vpc.code_category = 'PSYCH'
