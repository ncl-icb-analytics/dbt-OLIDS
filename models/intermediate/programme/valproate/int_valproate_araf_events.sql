{{ config(
    materialized='table',
    description='Intermediate table extracting all ARAF-related events for each person, using mapped concepts, observation, and valproate program codes. Applies lookback logic as defined in valproate program codes.',
    post_hook=[
        "COMMENT ON TABLE {{ this }} IS 'Intermediate: Valproate ARAF Events - Comprehensive collection of all Annual Risk Acknowledgement Form events for valproate patient safety monitoring.

Clinical Purpose:
â€¢ Gathers all ARAF completion events for patients on valproate therapy
â€¢ Supports annual risk acknowledgement monitoring for valproate clinical safety
â€¢ Enables comprehensive tracking of ARAF completion with lookback logic applied
â€¢ Provides foundation data for valproate programme safety compliance and risk acknowledgement

Data Granularity:
â€¢ One row per ARAF event observation for patients on valproate therapy
â€¢ Applies lookback logic as defined in valproate programme codes for current relevance
â€¢ Includes specific ARAF form code identification flags for detailed analysis
â€¢ Contains clinical effective dates for temporal analysis and programme tracking

Key Features:
â€¢ ARAF code category filtering with specific form code identification
â€¢ Lookback logic application based on valproate programme code configuration
â€¢ Integration with valproate programme codes for comprehensive ARAF tracking
â€¢ Support for valproate patient safety monitoring and annual risk acknowledgement compliance

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
    ]
) }}

SELECT
    pp.person_id,
    o.clinical_effective_date::date AS araf_event_date,
    o.id AS araf_observation_id,
    mc.concept_code AS araf_concept_code,
    mc.code_description AS araf_concept_display,
    vpc.code_category AS araf_code_category,
    coalesce (vpc.code_category = 'ARAF', FALSE)
        AS is_specific_araf_form_code
FROM {{ ref('stg_olids_observation') }} AS o
INNER JOIN {{ ref('stg_codesets_mapped_concepts') }} AS mc
    ON o.observation_core_concept_id = mc.source_code_id
INNER JOIN {{ ref('stg_codesets_valproate_prog_codes') }} AS vpc
    ON mc.concept_code = vpc.code
INNER JOIN {{ ref('stg_olids_patient_person') }} AS pp
    ON o.patient_id = pp.patient_id
WHERE
    vpc.code_category = 'ARAF'
    AND (
        vpc.lookback_years_offset IS NULL
        OR o.clinical_effective_date::date
        >= dateadd(YEAR, vpc.lookback_years_offset, current_date())
    )
