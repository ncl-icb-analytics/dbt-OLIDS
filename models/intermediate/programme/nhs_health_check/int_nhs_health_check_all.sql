{{
    config(
        materialized='table',
        cluster_by=['person_id', 'clinical_effective_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: NHS Health Check All - Comprehensive collection of all NHS Health Check completion events with enhanced analytics features.

Clinical Purpose:
â€¢ Gathers all NHS Health Check completion events for programme analysis and reporting
â€¢ Supports health check type classification and eligibility assessment for 40-74 age group
â€¢ Enables comprehensive time-based analysis and currency tracking for health checks
â€¢ Provides foundation data for QOF prevention pathway integration and risk factor assessment

Data Granularity:
â€¢ One row per NHS Health Check completion observation for all persons (active, inactive, deceased)
â€¢ Covers standard, initial, follow-up health checks, and cardiovascular risk assessments
â€¢ Includes enhanced time calculations and health check currency flags (12m, 24m, 5y intervals)
â€¢ Contains health check type classification and clinical context information

Key Features:
â€¢ Cluster ID: HEALTH_CHECK_COMP with validated SNOMED codes for completed health checks
â€¢ Enhanced analytics: type classification, eligibility assessment, timeframe analysis
â€¢ QOF prevention pathway integration support with 5-year cycle tracking
â€¢ Comprehensive health check status interpretation and clinical context flags

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/dbt-olids'"
        ]
    )
}}

/*
All NHS Health Check completed events with enhanced analytics features.
Uses HEALTH_CHECK_COMP cluster with validated SNOMED codes for completed health checks.

Enhanced Analytics Features:
- Health check type classification and eligibility assessment
- Enhanced timeframe analysis and currency tracking
- QOF prevention pathway integration support
- Risk factor assessment context

Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
*/

SELECT
    obs.observation_id,
    obs.person_id,
    obs.clinical_effective_date,
    obs.mapped_concept_code AS concept_code,
    obs.mapped_concept_display AS concept_display,
    'HEALTH_CHECK_COMP' AS source_cluster_id,

    -- All records represent completed NHS Health Checks
    TRUE AS is_completed_health_check,
    TRUE AS is_nhs_health_check_code,

    -- Health check type classification based on concept codes
    CASE
        WHEN obs.mapped_concept_code IN ('1959151000006103', '523221000000100') THEN 'Standard NHS Health Check'
        WHEN obs.mapped_concept_code IN ('1948791000006100', '1728781000006106') THEN 'Initial NHS Health Check'
        WHEN obs.mapped_concept_code IN ('1728811000006108', '1728801000006105', '1728791000006109') THEN 'Follow-up NHS Health Check'
        WHEN obs.mapped_concept_code IN ('840391000000101', '840401000000103') THEN 'Cardiovascular Risk Assessment'
        WHEN obs.mapped_concept_code IN ('1053551000000105', '904471000000104', '904481000000102') THEN 'Health Check Review'
        ELSE 'NHS Health Check'
    END AS health_check_type_classification,

    -- Clinical context for health checks
    CASE
        WHEN obs.mapped_concept_code IN ('840391000000101', '840401000000103') THEN 'CVD Risk Assessment Focus'
        WHEN obs.mapped_concept_code IN ('1053551000000105', '904471000000104') THEN 'Review and Follow-up'
        ELSE 'Prevention and Early Detection'
    END AS health_check_clinical_context,

    -- Age-based eligibility context (using age dimension)
    CASE
        WHEN age.age BETWEEN 40 AND 74 THEN 'Eligible Age Group (40-74)'
        WHEN age.age < 40 THEN 'Below Standard Age (Under 40)'
        WHEN age.age > 74 THEN 'Above Standard Age (Over 74)'
        ELSE 'Age Assessment Required'
    END AS eligibility_status_by_age,

    -- Clinical flags for analytics
    CASE
        WHEN obs.mapped_concept_code IN ('840391000000101', '840401000000103') THEN TRUE
        ELSE FALSE
    END AS includes_cvd_risk_assessment,

    CASE
        WHEN obs.mapped_concept_code IN ('1728811000006108', '1728801000006105', '1728791000006109',
                                         '1053551000000105', '904471000000104', '904481000000102') THEN TRUE
        ELSE FALSE
    END AS is_follow_up_check,

    -- Enhanced time calculations
    DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) AS days_since_health_check,
    ROUND(DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) / 365.25, 1) AS years_since_health_check,

    -- Health check currency flags (standard intervals)
    CASE
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 365 THEN TRUE
        ELSE FALSE
    END AS health_check_current_12m,

    CASE
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 730 THEN TRUE
        ELSE FALSE
    END AS health_check_current_24m,

    -- NHS Health Check cycle (5 years)
    CASE
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 1825 THEN TRUE
        ELSE FALSE
    END AS health_check_current_5y,

    -- QOF prevention pathway flags
    CASE
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 1825 THEN TRUE
        ELSE FALSE
    END AS meets_qof_prevention_requirement,

    -- Clinical interpretation for reporting
    CASE
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 1825
        THEN 'Current (within 5 years)'
        WHEN DATEDIFF(day, obs.clinical_effective_date, CURRENT_DATE()) <= 2555
        THEN 'Recent (within 7 years)'
        ELSE 'Overdue (>7 years)'
    END AS health_check_status_interpretation

FROM ({{ get_observations("'HEALTH_CHECK_COMP'") }}) obs
LEFT JOIN {{ ref('dim_person_active_patients') }} ap
    ON obs.person_id = ap.person_id
LEFT JOIN {{ ref('dim_person_age') }} age
    ON obs.person_id = age.person_id
WHERE obs.clinical_effective_date IS NOT NULL
  AND obs.mapped_concept_code IN (
      '1959151000006103',
      '1948791000006100',
      '1728781000006106',
      '523221000000100',
      '1728811000006108',
      '1728801000006105',
      '1728791000006109',
      '840391000000101',
      '840401000000103',
      '1053551000000105',
      '904471000000104',
      '904481000000102'
  )

ORDER BY person_id, clinical_effective_date DESC
