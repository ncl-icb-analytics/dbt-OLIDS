{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: NHS Health Check Latest - Latest NHS Health Check completion per person for programme analysis and eligibility assessment.

Clinical Purpose:
â€¢ Provides most recent NHS Health Check completion status for each person
â€¢ Supports health check programme analysis and eligibility assessment for current status
â€¢ Enables identification of patients requiring health check invitations or follow-up
â€¢ Provides foundation data for health check currency tracking and programme planning

Data Granularity:
â€¢ One row per person representing their most recent NHS Health Check completion
â€¢ Derived from comprehensive NHS Health Check events using latest event logic
â€¢ Includes key temporal flags for health check currency (12m, 24m, 5y intervals)
â€¢ Contains essential health check completion indicators and time calculations

Key Features:
â€¢ Latest event selection per person using clinical_effective_date ordering
â€¢ Health check currency flags for programme eligibility assessment
â€¢ Time-based calculations for programme planning and invitation scheduling
â€¢ Integration with comprehensive NHS Health Check events for complete programme analysis

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/dbt-olids'"
        ]
    )
}}

/*
Latest NHS Health Check completion per person.
Used for health check programme analysis and eligibility assessment.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    concept_code,
    concept_display,
    is_completed_health_check,
    days_since_health_check,
    health_check_current_12m,
    health_check_current_24m,
    health_check_current_5y,
    years_since_health_check

FROM (
    {{ get_latest_events(
        ref('int_nhs_health_check_all'),
        partition_by=['person_id'],
        order_by='clinical_effective_date'
    ) }}
) latest_health_check
