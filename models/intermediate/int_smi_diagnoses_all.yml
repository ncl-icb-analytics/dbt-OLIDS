version: 2
models:
- name: int_smi_diagnoses_all
  tests:
  - test_cluster_ids_exist:
      cluster_ids: SMIRES_COD, SMI_COD
  description: "All serious mental illness diagnosis observations from clinical records using QOF cluster IDs.\nProvides comprehensive\
    \ data collection for SMI register and mental health care monitoring.\n\nQOF Cluster IDs Used:\n- MH_COD: Mental health\
    \ diagnoses\n- MHREM_COD: Mental health remission codes\n\nClinical Purpose:\n- QOF SMI register data collection (mental\
    \ health diagnosis not in remission OR recent lithium therapy)\n- Mental health care pathway monitoring\n- Treatment response\
    \ tracking\n- Lithium therapy integration support\n\nKey QOF Requirements:\n- Register inclusion: Mental health diagnosis\
    \ (MH_COD) not in remission (latest MH_COD > latest MHREM_COD)\n- OR recent lithium therapy (handled separately in medication\
    \ models)\n- No age restrictions for SMI register\n- Requires integration with lithium medication orders for complete\
    \ register\n\nNote: This model provides diagnosis codes only. Lithium therapy integration is handled \nin the corresponding\
    \ fact table which joins to int_lithium_medications_all.\n\nIncludes ALL persons following intermediate layer principles.\n\
    Use as input for fct_person_smi_register.sql which applies QOF business rules and medication integration.\n"
  columns:
  - name: person_id
    description: Unique person identifier
    tests:
    - not_null
  - name: observation_id
    description: Unique observation identifier
    tests:
    - not_null
  - name: clinical_effective_date
    description: Date of the mental health diagnosis observation
    tests:
    - not_null
  - name: concept_code
    description: SNOMED concept code for mental health diagnosis
    tests:
    - not_null
  - name: concept_display
    description: Description of the mental health diagnosis code
    tests:
    - not_null
  - name: source_cluster_id
    description: QOF cluster ID (MH_COD, MHREM_COD)
    tests:
    - not_null
    - accepted_values:
        values:
        - MH_COD
        - MHREM_COD
  - name: earliest_mh_diagnosis_date
    description: Earliest mental health diagnosis date for this person
  - name: latest_mh_diagnosis_date
    description: Latest mental health diagnosis date for this person
  - name: earliest_remission_date
    description: Earliest mental health remission date for this person
  - name: latest_remission_date
    description: Latest mental health remission date for this person
  - name: all_mh_diagnosis_concept_codes
    description: Array of all mental health diagnosis concept codes for this person
  - name: all_mh_diagnosis_concept_displays
    description: Array of all mental health diagnosis concept displays for this person
  - name: all_remission_concept_codes
    description: Array of all mental health remission concept codes for this person
  - name: all_remission_concept_displays
    description: Array of all mental health remission concept displays for this person
