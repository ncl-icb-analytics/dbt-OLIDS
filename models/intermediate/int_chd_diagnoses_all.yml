version: 2

models:
  - name: int_chd_diagnoses_all
    description: |
      All coronary heart disease (CHD) diagnoses from clinical records.
      Uses QOF cluster ID CHD_COD for all forms of CHD diagnosis.
      
      Clinical Purpose:
      - CHD register inclusion for QOF cardiovascular disease management
      - Cardiovascular risk stratification and monitoring  
      - Secondary prevention pathway identification
      
      QOF Context:
      CHD register follows simple diagnosis-only pattern - any CHD diagnosis code qualifies 
      for register inclusion. No resolution codes or complex criteria. This is a lifelong 
      condition register for cardiovascular secondary prevention.
      
      Key Clinical Notes:
      - CHD is considered a permanent condition (no resolution codes)
      - Register inclusion based purely on presence of diagnostic codes
      - Important for secondary prevention medication monitoring
      - No age restrictions for CHD register
      
      Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
      Use this model as input for CHD register and cardiovascular risk models.
      
    tests:
      - cluster_ids_exist:
          cluster_ids: "CHD_COD"
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id

    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person')
              field: person_id

      - name: has_chd_diagnosis
        description: "Flag indicating person has at least one CHD diagnosis (always TRUE in this model)"
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: earliest_chd_date
        description: "Date of first recorded CHD diagnosis"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "<= latest_chd_date"

      - name: latest_chd_date
        description: "Date of most recent CHD diagnosis"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= earliest_chd_date"
          - dbt_utils.expression_is_true:
              expression: "<= current_date()"

      - name: total_chd_episodes
        description: "Total number of distinct CHD diagnosis dates"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 100

      - name: has_episode_last_12m
        description: "Boolean flag: has CHD diagnosis in last 12 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: has_episode_last_24m
        description: "Boolean flag: has CHD diagnosis in last 24 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: all_chd_concept_codes
        description: "Array of all distinct CHD concept codes for this person"
        tests:
          - not_null

      - name: all_chd_concept_displays
        description: "Array of all distinct CHD concept descriptions for this person"
        tests:
          - not_null

      - name: latest_chd_concept_code
        description: "Concept code from most recent CHD diagnosis"
        tests:
          - not_null

      - name: latest_chd_concept_description
        description: "Concept description from most recent CHD diagnosis"
        tests:
          - not_null 