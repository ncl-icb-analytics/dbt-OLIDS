version: 2

models:
  - name: int_chd_diagnoses_all
    description: |
      All coronary heart disease (CHD) diagnoses from clinical records.
      Uses QOF cluster ID CHD_COD for all forms of CHD diagnosis.
      
      Clinical Purpose:
      - CHD register inclusion for QOF cardiovascular disease management
      - Cardiovascular risk stratification and monitoring  
      - Secondary prevention pathway identification
      
      QOF Context:
      CHD register follows simple diagnosis-only pattern - any CHD diagnosis code qualifies 
      for register inclusion. No resolution codes or complex criteria. This is a lifelong 
      condition register for cardiovascular secondary prevention.
      
      Key Clinical Notes:
      - CHD is considered a permanent condition (no resolution codes)
      - Register inclusion based purely on presence of diagnostic codes
      - Important for secondary prevention medication monitoring
      - No age restrictions for CHD register
      
      This is OBSERVATION-LEVEL data - one row per CHD observation.
      Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
      Use this model as input for CHD register and cardiovascular risk models.
      
    columns:
      - name: observation_id
        description: "Unique observation identifier"
        tests:
          - not_null
          - unique

      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person')
              field: person_id

      - name: clinical_effective_date
        description: "Date when the CHD diagnosis was recorded"
        tests:
          - not_null

      - name: concept_code
        description: "SNOMED CT concept code for the CHD diagnosis"
        tests:
          - not_null

      - name: concept_display
        description: "Human readable description of the CHD diagnosis"
        tests:
          - not_null

      - name: source_cluster_id
        description: "Source cluster identifier (should be CHD_COD)"
        tests:
          - not_null
          - accepted_values:
              values: ['CHD_COD']

      - name: is_chd_diagnosis
        description: "Flag indicating this is a CHD diagnosis (always TRUE in this model)"
        tests:
          - not_null
          - accepted_values:
              values: [true]

    tests:
      - cluster_ids_exist:
          cluster_ids: "CHD_COD"
    tests:
      - cluster_ids_exist:
          cluster_ids: "CHD_COD"
      - dbt_utils.expression_is_true:
          expression: "count(*) > 0"
          config:
            severity: warn
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - observation_id
            - concept_code
            - cluster_id 