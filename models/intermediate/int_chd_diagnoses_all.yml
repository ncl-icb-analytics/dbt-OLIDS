version: 2

models:
  - name: int_chd_diagnoses_all
    description: |
      All coronary heart disease (CHD) diagnosis observations from clinical records using QOF cluster ID.
      Provides comprehensive data collection for CHD register and cardiovascular risk management.
      
      QOF Cluster IDs Used:
      - CHD_COD: Coronary heart disease diagnoses
      
      Clinical Purpose:
      - QOF CHD register data collection
      - Cardiovascular risk assessment
      - Coronary disease management monitoring
      - Secondary prevention planning
      
      Key QOF Requirements:
      - Register inclusion: Presence of CHD diagnosis code (CHD_COD)
      - No age restrictions for CHD register
      - No resolution codes - CHD is considered permanent condition
      - Important for cardiovascular disease secondary prevention
      
      Includes ALL persons following intermediate layer principles.
      Use as input for fct_person_chd_register.sql which applies QOF business rules.
      
    tests:
      - cluster_ids_exist:
          cluster_ids: "CHD_COD"
          
    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          
      - name: observation_id
        description: "Unique observation identifier"
        tests:
          - not_null
          
      - name: clinical_effective_date
        description: "Date of the CHD diagnosis observation"
        tests:
          - not_null
          
      - name: concept_code
        description: "SNOMED concept code for CHD diagnosis"
        tests:
          - not_null
          
      - name: concept_display
        description: "Description of the CHD diagnosis code"
        tests:
          - not_null
          
      - name: source_cluster_id
        description: "QOF cluster ID (CHD_COD)"
        tests:
          - not_null
          - accepted_values:
              values: ['CHD_COD']
              
      - name: is_chd_diagnosis_code
        description: "Flag indicating CHD diagnosis (CHD_COD)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: earliest_chd_diagnosis_date
        description: "Earliest CHD diagnosis date for this person"
        
      - name: latest_chd_diagnosis_date
        description: "Latest CHD diagnosis date for this person"
        
      - name: total_chd_diagnoses
        description: "Total number of CHD diagnosis codes for this person"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 100
              
      - name: chd_observation_type
        description: "Classification of this observation"
        tests:
          - not_null
          - accepted_values:
              values: ['CHD Diagnosis', 'Unknown']
              
      - name: has_chd_diagnosis
        description: "Flag indicating presence of CHD diagnosis"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_recent_chd_diagnosis
        description: "Flag indicating CHD diagnosis in last 12 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_chd_diagnosis_last_24m
        description: "Flag indicating CHD diagnosis in last 24 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_single_chd_diagnosis
        description: "Flag indicating only one CHD diagnosis code"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_multiple_chd_diagnoses
        description: "Flag indicating multiple CHD diagnosis codes"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: days_since_first_chd_diagnosis
        description: "Number of days since first CHD diagnosis"
        
      - name: is_newly_diagnosed_chd
        description: "Flag indicating CHD diagnosed within last year"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_established_chd
        description: "Flag indicating CHD diagnosed over a year ago"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_long_term_chd
        description: "Flag indicating CHD diagnosed over 5 years ago"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: has_chd_progression_codes
        description: "Flag indicating multiple CHD codes over time suggesting progression"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: all_chd_concept_codes
        description: "Array of all CHD concept codes for this person"
        
      - name: all_chd_concept_displays
        description: "Array of all CHD concept displays for this person" 