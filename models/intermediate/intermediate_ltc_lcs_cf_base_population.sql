CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_CF_BASE_POPULATION (
    PERSON_ID,
    SK_PATIENT_ID,
    CONDITION_CODE,
    IS_ON_REGISTER
)
COMMENT = 'Reusable base population for LTC LCS case finding indicators. Excludes patients already in LTC programmes and those with NHS health checks in the last 24 months.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS
WITH HealthChecks AS (
    -- Get patients with health checks in last 24 months
    SELECT DISTINCT
        PERSON_ID
    FROM DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
    WHERE CLUSTER_ID = 'HEALTH_CHECK_COMP'
        AND CLINICAL_EFFECTIVE_DATE >= DATEADD(month, -24, CURRENT_DATE())
)
SELECT DISTINCT
    PERSON_ID,
    SK_PATIENT_ID,
    CONDITION_CODE,
    IS_ON_REGISTER
FROM DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.FCT_PERSON_LTC_SUMMARY
WHERE PERSON_ID NOT IN (
    -- Exclude patients already in LTC programmes
    SELECT PERSON_ID 
    FROM DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.DIM_PROG_LTC_LCS_CF_EXCLUSIONS
)
AND PERSON_ID NOT IN (
    -- Exclude patients with health checks in last 24 months
    SELECT PERSON_ID
    FROM HealthChecks
); 