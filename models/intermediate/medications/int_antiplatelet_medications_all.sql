{{
    config(
        materialized='table',
        cluster_by=['person_id', 'order_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Antiplatelet Medication Orders - All recorded antiplatelet prescriptions.

Clinical Purpose:
â€¢ Tracks antiplatelet therapy for cardiovascular protection and thrombosis prevention
â€¢ Supports dual antiplatelet therapy (DAPT) monitoring and medication review processes
â€¢ Enables analysis of prescribing patterns by P2Y12 inhibitor usage

Data Granularity:
â€¢ One row per medication order
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Historical data maintained for longitudinal analysis

Key Features:
â€¢ Classification by specific antiplatelet type (aspirin, clopidogrel, ticagrelor, etc.)
â€¢ P2Y12 inhibitor identification for DAPT analysis
â€¢ Evidence-based therapy flags with clinical trial references
â€¢ Low-dose aspirin identification for cardioprotection

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
All antiplatelet medication orders for cardiovascular protection and thrombosis prevention.
Uses BNF classification (2.9) for antiplatelet drugs.
Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
*/

SELECT
    person_id,
    medication_order_id,
    medication_statement_id,
    order_date,
    order_medication_name,
    order_dose,
    order_quantity_value,
    order_quantity_unit,
    order_duration_days,
    statement_medication_name,
    mapped_concept_code,
    mapped_concept_display,
    bnf_code,
    bnf_name,

    -- Specific antiplatelet classification
    CASE
        WHEN bnf_code LIKE '%ASPIRIN%' OR bnf_code LIKE '0209000502%' THEN 'ASPIRIN'
        WHEN bnf_code LIKE '%CLOPIDOGREL%' OR bnf_code LIKE '0209000510%' THEN 'CLOPIDOGREL'
        WHEN bnf_code LIKE '%DIPYRIDAMOLE%' OR bnf_code LIKE '0209000515%' THEN 'DIPYRIDAMOLE'
        WHEN bnf_code LIKE '%PRASUGREL%' OR bnf_code LIKE '0209000525%' THEN 'PRASUGREL'
        WHEN bnf_code LIKE '%TICAGRELOR%' OR bnf_code LIKE '0209000530%' THEN 'TICAGRELOR'
        WHEN bnf_code LIKE '%TICLOPIDINE%' OR bnf_code LIKE '0209000535%' THEN 'TICLOPIDINE'
        ELSE 'OTHER_ANTIPLATELET'
    END AS antiplatelet_type,

    -- P2Y12 inhibitor classification (for dual antiplatelet therapy)
    CASE
        WHEN bnf_code LIKE '%CLOPIDOGREL%' OR bnf_code LIKE '0209000510%' THEN TRUE
        WHEN bnf_code LIKE '%PRASUGREL%' OR bnf_code LIKE '0209000525%' THEN TRUE
        WHEN bnf_code LIKE '%TICAGRELOR%' OR bnf_code LIKE '0209000530%' THEN TRUE
        WHEN bnf_code LIKE '%TICLOPIDINE%' OR bnf_code LIKE '0209000535%' THEN TRUE
        ELSE FALSE
    END AS is_p2y12_inhibitor,

    -- Evidence-based antiplatelets
    CASE
        WHEN bnf_code LIKE '%ASPIRIN%' OR bnf_code LIKE '0209000502%' THEN TRUE      -- Multiple trials
        WHEN bnf_code LIKE '%CLOPIDOGREL%' OR bnf_code LIKE '0209000510%' THEN TRUE  -- CAPRIE, CURE trials
        WHEN bnf_code LIKE '%TICAGRELOR%' OR bnf_code LIKE '0209000530%' THEN TRUE   -- PLATO trial
        WHEN bnf_code LIKE '%PRASUGREL%' OR bnf_code LIKE '0209000525%' THEN TRUE    -- TRITON-TIMI trial
        ELSE FALSE
    END AS is_evidence_based_cvd,

    -- Common antiplatelets flags
    CASE WHEN bnf_code LIKE '%ASPIRIN%' OR bnf_code LIKE '0209000502%' THEN TRUE ELSE FALSE END AS is_aspirin,
    CASE WHEN bnf_code LIKE '%CLOPIDOGREL%' OR bnf_code LIKE '0209000510%' THEN TRUE ELSE FALSE END AS is_clopidogrel,
    CASE WHEN bnf_code LIKE '%TICAGRELOR%' OR bnf_code LIKE '0209000530%' THEN TRUE ELSE FALSE END AS is_ticagrelor,
    CASE WHEN bnf_code LIKE '%PRASUGREL%' OR bnf_code LIKE '0209000525%' THEN TRUE ELSE FALSE END AS is_prasugrel,
    CASE WHEN bnf_code LIKE '%DIPYRIDAMOLE%' OR bnf_code LIKE '0209000515%' THEN TRUE ELSE FALSE END AS is_dipyridamole,

    -- Low dose aspirin flag (typically 75mg for cardioprotection)
    CASE
        WHEN (bnf_code LIKE '%ASPIRIN%' OR bnf_code LIKE '0209000502%')
             AND (order_dose LIKE '%75%' OR order_dose LIKE '%low%') THEN TRUE
        ELSE FALSE
    END AS is_low_dose_aspirin,

    -- Calculate time since order
    DATEDIFF(day, order_date, CURRENT_DATE()) AS days_since_order,

    -- Order recency flags (antiplatelets are typically long-term therapy)
    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 90 THEN TRUE
        ELSE FALSE
    END AS is_recent_3m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 180 THEN TRUE
        ELSE FALSE
    END AS is_recent_6m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 365 THEN TRUE
        ELSE FALSE
    END AS is_recent_12m

FROM (
    {{ get_medication_orders(bnf_code='0209') }}
) base_orders
ORDER BY person_id, order_date DESC
