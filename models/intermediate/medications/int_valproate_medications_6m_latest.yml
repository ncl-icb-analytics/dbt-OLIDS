version: 2
models:
- name: int_valproate_medications_6m_latest
  description: 'Intermediate: Valproate Medication Orders (6 months latest) - Most recent valproate prescription per person for safety monitoring.


    Clinical Purpose:

    • Tracks latest valproate therapy for pregnancy safety and teratogenicity monitoring

    • Supports valproate programme safety initiatives and clinical oversight

    • Enables person-level analysis of current valproate exposure status


    Data Granularity:

    • One row per person with latest valproate order in last 6 months

    • Includes all patients regardless of status (active/inactive/deceased)

    • Critical for pregnancy + valproate safety combinations


    Key Features:

    • Latest order identification with recency count tracking

    • Valproate product classification for brand consistency monitoring

    • Focused dataset for clinical safety interventions

    • Essential input for valproate programme risk assessment'
  config:
    materialized: table
  columns:
  - name: person_id
    description: Unique person identifier
    tests:
    - not_null
    - unique
    - relationships:
        to: ref('dim_person')
        field: person_id
  - name: most_recent_order_date
    description: Date of most recent valproate order within last 6 months
    tests:
    - not_null
  - name: medication_order_id
    description: Unique identifier for the medication order
    tests:
    - not_null
  - name: medication_statement_id
    description: Linked medication statement identifier
  - name: order_medication_name
    description: Medication name from the order
    tests:
    - not_null
  - name: order_dose
    description: Dosage information from the order
  - name: order_quantity_value
    description: Numeric quantity from the order
  - name: order_quantity_unit
    description: Unit for the quantity
  - name: order_duration_days
    description: Duration of prescription in days
  - name: statement_medication_name
    description: Medication name from the linked statement
  - name: mapped_concept_code
    description: SNOMED concept code for the valproate product
    tests:
    - not_null
  - name: mapped_concept_display
    description: Display term for the mapped concept
    tests:
    - not_null
  - name: valproate_product_term
    description: Classified valproate product type (EPILIM, CONVULEX, etc.)
    tests:
    - not_null
    - accepted_values:
        values:
        - EPILIM
        - CONVULEX
        - DEPAKOTE
        - EPISENTA
        - VALPROATE_GENERIC
        - OTHER_VALPROATE
  - name: recent_order_count
    description: Total count of valproate orders for this person in last 6 months
    tests:
    - not_null
    - dbt_utils.accepted_range:
        min_value: 1
