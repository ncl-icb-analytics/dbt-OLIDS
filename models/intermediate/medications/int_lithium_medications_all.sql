{{
    config(
        materialized='table',
        cluster_by=['person_id', 'order_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Lithium Medication Orders - All recorded lithium prescriptions for bipolar disorder.

Clinical Purpose:
â€¢ Tracks lithium therapy for bipolar disorder and severe depression management
â€¢ Supports therapeutic drug monitoring and medication safety processes
â€¢ Enables analysis of brand consistency and bioequivalence considerations

Data Granularity:
â€¢ One row per medication order
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Historical data maintained for longitudinal analysis

Key Features:
â€¢ Classification by lithium preparation type (carbonate vs citrate)
â€¢ Brand identification for bioequivalence monitoring (Priadel, Camcolit)
â€¢ Dose categorisation for therapeutic range assessment
â€¢ Mandatory monitoring requirement flags for patient safety

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/dbt-olids'"
        ]
    )
}}

/*
All lithium medication orders for bipolar disorder and severe depression.
Uses BNF classification (4.2.3) for lithium.
Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
*/

SELECT
    person_id,
    medication_order_id,
    medication_statement_id,
    order_date,
    order_medication_name,
    order_dose,
    order_quantity_value,
    order_quantity_unit,
    order_duration_days,
    statement_medication_name,
    mapped_concept_code,
    mapped_concept_display,
    bnf_code,
    bnf_name,

    -- Specific lithium preparation classification
    CASE
        WHEN statement_medication_name LIKE '%LITHIUM CARBONATE%' OR bnf_code LIKE '0402030M0%' THEN 'LITHIUM_CARBONATE'
        WHEN statement_medication_name LIKE '%LITHIUM CITRATE%' OR bnf_code LIKE '0402030N0%' THEN 'LITHIUM_CITRATE'
        ELSE 'OTHER_LITHIUM'
    END AS lithium_type,

    -- Brand classification (important for bioequivalence)
    CASE
        WHEN order_medication_name LIKE '%PRIADEL%' OR statement_medication_name LIKE '%PRIADEL%' THEN 'PRIADEL'
        WHEN order_medication_name LIKE '%CAMCOLIT%' OR statement_medication_name LIKE '%CAMCOLIT%' THEN 'CAMCOLIT'
        WHEN order_medication_name LIKE '%LISKONUM%' OR statement_medication_name LIKE '%LISKONUM%' THEN 'LISKONUM'
        WHEN order_medication_name LIKE '%LI-LIQUID%' OR statement_medication_name LIKE '%LI-LIQUID%' THEN 'LI_LIQUID'
        ELSE 'OTHER_BRAND'
    END AS lithium_brand,

    -- Lithium preparation flags
    CASE WHEN statement_medication_name LIKE '%LITHIUM CARBONATE%' OR bnf_code LIKE '0402030M0%' THEN TRUE ELSE FALSE END AS is_lithium_carbonate,
    CASE WHEN statement_medication_name LIKE '%LITHIUM CITRATE%' OR bnf_code LIKE '0402030N0%' THEN TRUE ELSE FALSE END AS is_lithium_citrate,

    -- Common brand flags
    CASE WHEN order_medication_name LIKE '%PRIADEL%' OR statement_medication_name LIKE '%PRIADEL%' THEN TRUE ELSE FALSE END AS is_priadel,
    CASE WHEN order_medication_name LIKE '%CAMCOLIT%' OR statement_medication_name LIKE '%CAMCOLIT%' THEN TRUE ELSE FALSE END AS is_camcolit,

    -- Dose range classification for lithium carbonate (standard therapeutic doses)
    CASE
        WHEN statement_medication_name LIKE '%LITHIUM CARBONATE%' AND (
            order_dose LIKE '%200%' OR order_dose LIKE '%300%' OR order_dose LIKE '%400%'
        ) THEN 'STANDARD_DOSE'
        WHEN statement_medication_name LIKE '%LITHIUM CARBONATE%' AND (
            order_dose LIKE '%600%' OR order_dose LIKE '%800%' OR order_dose LIKE '%1000%' OR order_dose LIKE '%1200%'
        ) THEN 'HIGH_DOSE'
        WHEN statement_medication_name LIKE '%LITHIUM CARBONATE%' AND (
            order_dose LIKE '%100%' OR order_dose LIKE '%150%'
        ) THEN 'LOW_DOSE'
        ELSE 'UNKNOWN_DOSE'
    END AS lithium_dose_category,

    -- Formulation classification
    CASE
        WHEN order_medication_name LIKE '%TABLET%' OR statement_medication_name LIKE '%TABLET%' THEN 'TABLET'
        WHEN order_medication_name LIKE '%CAPSULE%' OR statement_medication_name LIKE '%CAPSULE%' THEN 'CAPSULE'
        WHEN order_medication_name LIKE '%LIQUID%' OR statement_medication_name LIKE '%LIQUID%' THEN 'LIQUID'
        ELSE 'UNKNOWN_FORMULATION'
    END AS formulation_type,

    -- Monitoring requirement flag (all lithium requires regular monitoring)
    TRUE AS requires_monitoring,

    -- Calculate time since order
    DATEDIFF(day, order_date, CURRENT_DATE()) AS days_since_order,

    -- Order recency flags (lithium requires regular monitoring and compliance tracking)
    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 90 THEN TRUE
        ELSE FALSE
    END AS is_recent_3m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 180 THEN TRUE
        ELSE FALSE
    END AS is_recent_6m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 365 THEN TRUE
        ELSE FALSE
    END AS is_recent_12m

FROM (
    {{ get_medication_orders(bnf_code='040203') }}
) base_orders
ORDER BY person_id, order_date DESC
