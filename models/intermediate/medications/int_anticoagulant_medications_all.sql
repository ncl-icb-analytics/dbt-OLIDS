{{
    config(
        materialized='table',
        cluster_by=['person_id', 'order_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Anticoagulant Medication Orders - All recorded oral anticoagulant prescriptions.

Clinical Purpose:
â€¢ Tracks anticoagulant therapy for thrombosis prevention and atrial fibrillation management
â€¢ Supports anticoagulation monitoring and medication review processes
â€¢ Enables analysis of prescribing patterns between DOACs and VKAs

Data Granularity:
â€¢ One row per medication order
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Historical data maintained for longitudinal analysis

Key Features:
â€¢ Classification by anticoagulant type (DOAC vs VKA)
â€¢ Specific medication mapping (warfarin, apixaban, rivaroxaban, etc.)
â€¢ Evidence-based therapy flags with clinical trial references
â€¢ Recency indicators for therapy monitoring (3m, 6m, 12m)

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
All oral anticoagulant medication orders for thrombosis prevention and atrial fibrillation management.
Uses BNF classification (2.8.2) for oral anticoagulants.
Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
*/

SELECT
    person_id,
    medication_order_id,
    medication_statement_id,
    order_date,
    order_medication_name,
    order_dose,
    order_quantity_value,
    order_quantity_unit,
    order_duration_days,
    statement_medication_name,
    mapped_concept_code,
    mapped_concept_display,
    bnf_code,
    bnf_name,

    -- Anticoagulant type classification
    CASE
        -- DOACs (Direct Oral Anticoagulants)
        WHEN bnf_code LIKE '%APIXABAN%' OR bnf_code LIKE '0208020Z%' THEN 'DOAC'
        WHEN bnf_code LIKE '%DABIGATRAN%' OR bnf_code LIKE '0208020X%' THEN 'DOAC'
        WHEN bnf_code LIKE '%EDOXABAN%' OR bnf_code LIKE '0208020AA%' THEN 'DOAC'
        WHEN bnf_code LIKE '%RIVAROXABAN%' OR bnf_code LIKE '0208020Y%' THEN 'DOAC'
        -- VKAs (Vitamin K Antagonists)
        WHEN bnf_code LIKE '%WARFARIN%' OR bnf_code LIKE '0208020V%' THEN 'VKA'
        WHEN bnf_code LIKE '%ACENOCOUMAROL%' OR bnf_code LIKE '0208020H%' THEN 'VKA'
        WHEN bnf_code LIKE '%PHENINDIONE%' OR bnf_code LIKE '0208020N%' THEN 'VKA'
        WHEN bnf_code LIKE '%PHENPROCOUMON%' OR bnf_code LIKE '0208020S%' THEN 'VKA'
        ELSE 'OTHER_ANTICOAGULANT'
    END AS anticoagulant_type,

    -- Specific anticoagulant classification
    CASE
        WHEN bnf_code LIKE '%APIXABAN%' OR bnf_code LIKE '0208020Z%' THEN 'APIXABAN'
        WHEN bnf_code LIKE '%DABIGATRAN%' OR bnf_code LIKE '0208020X%' THEN 'DABIGATRAN'
        WHEN bnf_code LIKE '%EDOXABAN%' OR bnf_code LIKE '0208020AA%' THEN 'EDOXABAN'
        WHEN bnf_code LIKE '%RIVAROXABAN%' OR bnf_code LIKE '0208020Y%' THEN 'RIVAROXABAN'
        WHEN bnf_code LIKE '%WARFARIN%' OR bnf_code LIKE '0208020V%' THEN 'WARFARIN'
        WHEN bnf_code LIKE '%ACENOCOUMAROL%' OR bnf_code LIKE '0208020H%' THEN 'ACENOCOUMAROL'
        WHEN bnf_code LIKE '%PHENINDIONE%' OR bnf_code LIKE '0208020N%' THEN 'PHENINDIONE'
        WHEN bnf_code LIKE '%PHENPROCOUMON%' OR bnf_code LIKE '0208020S%' THEN 'PHENPROCOUMON'
        ELSE 'OTHER_ANTICOAGULANT'
    END AS specific_anticoagulant,

    -- Evidence-based anticoagulants for AF
    CASE
        WHEN bnf_code LIKE '%APIXABAN%' OR bnf_code LIKE '0208020Z%' THEN TRUE    -- ARISTOTLE trial
        WHEN bnf_code LIKE '%DABIGATRAN%' OR bnf_code LIKE '0208020X%' THEN TRUE  -- RE-LY trial
        WHEN bnf_code LIKE '%RIVAROXABAN%' OR bnf_code LIKE '0208020Y%' THEN TRUE -- ROCKET-AF trial
        WHEN bnf_code LIKE '%EDOXABAN%' OR bnf_code LIKE '0208020AA%' THEN TRUE   -- ENGAGE-AF trial
        WHEN bnf_code LIKE '%WARFARIN%' OR bnf_code LIKE '0208020V%' THEN TRUE    -- Gold standard
        ELSE FALSE
    END AS is_evidence_based_af,

    -- Common anticoagulants flags
    CASE WHEN bnf_code LIKE '%WARFARIN%' OR bnf_code LIKE '0208020V%' THEN TRUE ELSE FALSE END AS is_warfarin,
    CASE WHEN bnf_code LIKE '%APIXABAN%' OR bnf_code LIKE '0208020Z%' THEN TRUE ELSE FALSE END AS is_apixaban,
    CASE WHEN bnf_code LIKE '%RIVAROXABAN%' OR bnf_code LIKE '0208020Y%' THEN TRUE ELSE FALSE END AS is_rivaroxaban,
    CASE WHEN bnf_code LIKE '%DABIGATRAN%' OR bnf_code LIKE '0208020X%' THEN TRUE ELSE FALSE END AS is_dabigatran,
    CASE WHEN bnf_code LIKE '%EDOXABAN%' OR bnf_code LIKE '0208020AA%' THEN TRUE ELSE FALSE END AS is_edoxaban,

    -- Anticoagulant class flags
    CASE
        WHEN bnf_code LIKE '%APIXABAN%' OR bnf_code LIKE '0208020Z%'
             OR bnf_code LIKE '%DABIGATRAN%' OR bnf_code LIKE '0208020X%'
             OR bnf_code LIKE '%RIVAROXABAN%' OR bnf_code LIKE '0208020Y%'
             OR bnf_code LIKE '%EDOXABAN%' OR bnf_code LIKE '0208020AA%' THEN TRUE
        ELSE FALSE
    END AS is_doac,

    CASE
        WHEN bnf_code LIKE '%WARFARIN%' OR bnf_code LIKE '0208020V%'
             OR bnf_code LIKE '%ACENOCOUMAROL%' OR bnf_code LIKE '0208020H%'
             OR bnf_code LIKE '%PHENINDIONE%' OR bnf_code LIKE '0208020N%'
             OR bnf_code LIKE '%PHENPROCOUMON%' OR bnf_code LIKE '0208020S%' THEN TRUE
        ELSE FALSE
    END AS is_vka,

    -- Calculate time since order
    DATEDIFF(day, order_date, CURRENT_DATE()) AS days_since_order,

    -- Order recency flags (anticoagulants are typically long-term therapy)
    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 90 THEN TRUE
        ELSE FALSE
    END AS is_recent_3m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 180 THEN TRUE
        ELSE FALSE
    END AS is_recent_6m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 365 THEN TRUE
        ELSE FALSE
    END AS is_recent_12m

FROM (
    {{ get_medication_orders(bnf_code='020802') }}
) base_orders
ORDER BY person_id, order_date DESC
