{{
    config(
        materialized='table',
        cluster_by=['person_id', 'order_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: ACE Inhibitor Medication Orders - All recorded ACE inhibitor prescriptions.

Clinical Purpose:
â€¢ Tracks ACE inhibitor therapy for cardiovascular and renal protection
â€¢ Supports clinical monitoring and medication review processes
â€¢ Enables analysis of prescribing patterns by specific ACE inhibitor type

Data Granularity:
â€¢ One row per medication order
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Historical data maintained for longitudinal analysis

Key Features:
â€¢ Classification by specific ACE inhibitor type (ramipril, lisinopril, etc.)
â€¢ Evidence-based medication flags for cardiovascular disease management
â€¢ Recency indicators for therapy monitoring (3m, 6m, 12m)
â€¢ Clinical trial evidence mapping (HOPE, EUROPA, GISSI-3, SOLVD trials)

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
All ACE inhibitor medication orders for cardiovascular and renal protection.
Uses BNF classification (2.5.5.1) for ACE inhibitors.
Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
*/

SELECT
    person_id,
    medication_order_id,
    medication_statement_id,
    order_date,
    order_medication_name,
    order_dose,
    order_quantity_value,
    order_quantity_unit,
    order_duration_days,
    statement_medication_name,
    mapped_concept_code,
    mapped_concept_display,
    bnf_code,
    bnf_name,

    -- Specific ACE inhibitor classification
    CASE
        WHEN bnf_code LIKE '0205050102%' THEN 'CAPTOPRIL'
        WHEN bnf_code LIKE '0205050105%' THEN 'CILAZAPRIL'
        WHEN bnf_code LIKE '0205050110%' THEN 'ENALAPRIL'
        WHEN bnf_code LIKE '0205050115%' THEN 'FOSINOPRIL'
        WHEN bnf_code LIKE '0205050120%' THEN 'IMIDAPRIL'
        WHEN bnf_code LIKE '0205050125%' THEN 'LISINOPRIL'
        WHEN bnf_code LIKE '0205050130%' THEN 'MOEXIPRIL'
        WHEN bnf_code LIKE '0205050135%' THEN 'PERINDOPRIL'
        WHEN bnf_code LIKE '0205050140%' THEN 'QUINAPRIL'
        WHEN bnf_code LIKE '0205050145%' THEN 'RAMIPRIL'
        WHEN bnf_code LIKE '0205050150%' THEN 'TRANDOLAPRIL'
        ELSE 'OTHER_ACE_INHIBITOR'
    END AS ace_inhibitor_type,

    -- Evidence-based ACE inhibitors (commonly used in cardiovascular disease)
    CASE
        WHEN bnf_code LIKE '0205050145%' THEN TRUE  -- Ramipril (HOPE trial)
        WHEN bnf_code LIKE '0205050135%' THEN TRUE  -- Perindopril (EUROPA trial)
        WHEN bnf_code LIKE '0205050125%' THEN TRUE  -- Lisinopril (GISSI-3 trial)
        WHEN bnf_code LIKE '0205050110%' THEN TRUE  -- Enalapril (SOLVD trial)
        ELSE FALSE
    END AS is_evidence_based_cvd,

    -- Common ACE inhibitors flags
    CASE WHEN bnf_code LIKE '0205050145%' THEN TRUE ELSE FALSE END AS is_ramipril,
    CASE WHEN bnf_code LIKE '0205050125%' THEN TRUE ELSE FALSE END AS is_lisinopril,
    CASE WHEN bnf_code LIKE '0205050135%' THEN TRUE ELSE FALSE END AS is_perindopril,
    CASE WHEN bnf_code LIKE '0205050110%' THEN TRUE ELSE FALSE END AS is_enalapril,
    CASE WHEN bnf_code LIKE '0205050102%' THEN TRUE ELSE FALSE END AS is_captopril,

    -- Calculate time since order
    DATEDIFF(day, order_date, CURRENT_DATE()) AS days_since_order,

    -- Order recency flags (ACE inhibitors are typically long-term therapy)
    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 90 THEN TRUE
        ELSE FALSE
    END AS is_recent_3m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 180 THEN TRUE
        ELSE FALSE
    END AS is_recent_6m,

    CASE
        WHEN DATEDIFF(day, order_date, CURRENT_DATE()) <= 365 THEN TRUE
        ELSE FALSE
    END AS is_recent_12m

FROM (
    {{ get_medication_orders(bnf_code='02050501') }}
) base_orders
ORDER BY person_id, order_date DESC
