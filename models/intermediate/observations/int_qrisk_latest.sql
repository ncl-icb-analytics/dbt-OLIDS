{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Latest QRISK Observations - Most recent valid cardiovascular risk score per person.

Clinical Purpose:
â€¢ Provides current cardiovascular risk status for primary prevention strategies
â€¢ Supports statin therapy decision-making and CVD risk management
â€¢ Enables current risk stratification and population health assessment

Data Granularity:
â€¢ One row per person with their most recent valid QRISK score
â€¢ Includes only patients with valid QRISK measurements
â€¢ Filtered to exclude implausible values for clinical accuracy

Key Features:
â€¢ Latest valid QRISK identification with type preservation (QRISK2/3)
â€¢ Clinical cardiovascular risk categorisation for treatment planning
â€¢ Statin consideration flags based on prevention guidelines
â€¢ Complete risk assessment metadata for clinical context

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
Latest valid QRISK cardiovascular risk score per person.
Uses the comprehensive int_qrisk_all model and filters to most recent valid QRISK.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    qrisk_score,
    qrisk_type,
    concept_code,
    concept_display,
    source_cluster_id,
    cvd_risk_category,
    is_high_cvd_risk,
    is_very_high_cvd_risk,
    warrants_statin_consideration,
    original_result_value

FROM (
    {{ get_latest_events(
        ref('int_qrisk_all'),
        partition_by=['person_id'],
        order_by='clinical_effective_date'
    ) }}
) latest_qrisk

WHERE is_valid_qrisk = TRUE
