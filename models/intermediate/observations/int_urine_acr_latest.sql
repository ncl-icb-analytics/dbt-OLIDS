{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Latest Urine ACR Observations - Most recent valid ACR measurement per person for kidney function assessment.

Clinical Purpose:
â€¢ Provides current kidney function status based on albumin-to-creatinine ratio
â€¢ Supports CKD staging and diabetic nephropathy assessment
â€¢ Enables current proteinuria status evaluation and clinical decision-making

Data Granularity:
â€¢ One row per person with their most recent valid ACR
â€¢ Includes only patients with valid ACR measurements
â€¢ Filtered to exclude implausible values for clinical accuracy

Key Features:
â€¢ Latest valid ACR identification using comprehensive filtering
â€¢ Clinical ACR categorisation for kidney damage assessment
â€¢ Microalbuminuria and macroalbuminuria flags for staging
â€¢ Complete observation metadata for clinical context

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/dbt-olids'"
        ]
    )
}}

/*
Latest valid urine ACR measurement per person.
Uses the comprehensive int_urine_acr_all model and filters to most recent valid ACR.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    acr_value,
    concept_code,
    concept_display,
    source_cluster_id,
    acr_category,
    is_acr_elevated,
    is_microalbuminuria,
    is_macroalbuminuria,
    original_result_value

FROM (
    {{ get_latest_events(
        ref('int_urine_acr_all'),
        partition_by=['person_id'],
        order_by='clinical_effective_date'
    ) }}
) latest_acr

WHERE is_valid_acr = TRUE
