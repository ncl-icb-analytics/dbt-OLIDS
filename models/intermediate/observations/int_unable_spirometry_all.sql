{{
    config(
        materialized='table',
        cluster_by=['person_id', 'clinical_effective_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Unable Spirometry Observations - All records where spirometry testing was unsuitable or contraindicated.

Clinical Purpose:
â€¢ Tracks spirometry contraindications for COPD register confirmation requirements
â€¢ Supports alternative pathway for COPD register inclusion when spirometry cannot be performed
â€¢ Enables documentation of clinical assessment limitations and patient factors

Data Granularity:
â€¢ One row per unable spirometry observation
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Uses SPIRPU_COD cluster for spirometry unsuitability identification

Key Features:
â€¢ Comprehensive documentation of spirometry contraindications
â€¢ Alternative evidence pathway for COPD register eligibility
â€¢ Clinical assessment limitation tracking for quality assurance
â€¢ Essential for COPD register spirometry validation processes

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
All unable-to-have-spirometry observations from clinical records.
Uses QOF cluster ID SPIRPU_COD for patients where spirometry is unsuitable.

Clinical Purpose:
- COPD register spirometry confirmation requirements (post-April 2023)
- Alternative pathway for COPD register inclusion when spirometry cannot be performed
- Documentation of contraindications or patient inability

Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
One row per unable spirometry observation.
Use this model as input for COPD register spirometry validation.
*/

SELECT
    obs.observation_id,
    obs.person_id,
    obs.clinical_effective_date,
    obs.mapped_concept_code AS concept_code,
    obs.mapped_concept_display AS concept_display,
    obs.cluster_id AS source_cluster_id,

    -- Unable spirometry-specific flags (observation-level only)
    TRUE AS is_unable_spirometry_record,

    -- Classification of this specific observation
    'Unable to Perform Spirometry' AS spirometry_observation_type

FROM ({{ get_observations("'SPIRPU_COD'") }}) obs
WHERE obs.clinical_effective_date IS NOT NULL

ORDER BY person_id, clinical_effective_date DESC
