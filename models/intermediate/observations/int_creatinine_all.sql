{{
    config(
        materialized='table',
        cluster_by=['person_id', 'clinical_effective_date'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Creatinine Observations - All recorded serum creatinine measurements with clinical categorisation.

Clinical Purpose:
â€¢ Tracks creatinine levels for kidney function assessment and CKD monitoring
â€¢ Supports renal disease management and medication dosing adjustments
â€¢ Enables chronic kidney disease case finding and progression monitoring

Data Granularity:
â€¢ One row per creatinine observation
â€¢ Includes all patients regardless of status (active/inactive/deceased)
â€¢ Uses CRE_COD cluster for serum creatinine identification

Key Features:
â€¢ Data quality validation with plausible range filtering (20-1000 Âµmol/L)
â€¢ Clinical creatinine categorisation (normal, mildly/moderately/severely elevated)
â€¢ Elevated creatinine flags for kidney function screening
â€¢ Original value preservation for clinical interpretation

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
All serum creatinine measurements from observations.
Includes ALL persons (active, inactive, deceased).
*/

WITH base_observations AS (

    SELECT
        obs.observation_id,
        obs.person_id,
        obs.clinical_effective_date,
        CAST(obs.result_value AS NUMBER(6,1)) AS creatinine_value,
        obs.result_unit_display,
        obs.mapped_concept_code AS concept_code,
        obs.mapped_concept_display AS concept_display,
        obs.cluster_id AS source_cluster_id,
        obs.result_value AS original_result_value

    FROM ({{ get_observations("'CRE_COD'") }}) obs
    WHERE obs.clinical_effective_date IS NOT NULL
      AND obs.result_value IS NOT NULL
)

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    creatinine_value,
    result_unit_display,
    concept_code,
    concept_display,
    source_cluster_id,
    original_result_value,

    -- Data quality validation (creatinine typically 40-400 Âµmol/L)
    CASE
        WHEN creatinine_value BETWEEN 20 AND 1000 THEN TRUE
        ELSE FALSE
    END AS is_valid_creatinine,

    -- Clinical categorisation (Âµmol/L) - general adult reference ranges
    CASE
        WHEN creatinine_value NOT BETWEEN 20 AND 1000 THEN 'Invalid'
        WHEN creatinine_value <= 120 THEN 'Normal'
        WHEN creatinine_value <= 200 THEN 'Mildly Elevated'
        WHEN creatinine_value <= 400 THEN 'Moderately Elevated'
        WHEN creatinine_value > 400 THEN 'Severely Elevated'
        ELSE 'Unknown'
    END AS creatinine_category,

    -- Elevated creatinine indicator (>120 Âµmol/L suggests possible kidney issues)
    CASE
        WHEN creatinine_value > 120 AND creatinine_value <= 1000 THEN TRUE
        ELSE FALSE
    END AS is_elevated_creatinine

FROM base_observations

-- Sort for consistent output
ORDER BY person_id, clinical_effective_date DESC
