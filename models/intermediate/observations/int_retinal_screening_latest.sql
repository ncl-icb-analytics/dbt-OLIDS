{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Latest Retinal Screening Observations - Most recent diabetes retinal screening completion per person.

Clinical Purpose:
â€¢ Provides current retinal screening status for diabetes care monitoring
â€¢ Supports QOF diabetes care process reporting and compliance assessment
â€¢ Enables current eye care status evaluation and screening programme management

Data Granularity:
â€¢ One row per person with their most recent completed retinal screening
â€¢ Includes only patients with completed screening records
â€¢ Focused on screening currency and compliance assessment

Key Features:
â€¢ Latest screening identification with currency flags (12m, 24m)
â€¢ Screening completion status for diabetes care pathway compliance
â€¢ Time-based screening status for QOF reporting
â€¢ Essential data for diabetes care process monitoring

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/dbt-olids'"
        ]
    )
}}

/*
Latest diabetes retinal screening completion per person.
Used for diabetes care processes and screening programme analysis.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    concept_code,
    concept_display,
    source_cluster_id,
    is_completed_screening,
    days_since_screening,
    screening_current_12m,
    screening_current_24m

FROM (
    {{ get_latest_events(
        ref('int_retinal_screening_all'),
        partition_by=['person_id'],
        order_by='clinical_effective_date'
    ) }}
) latest_retinal_screening
