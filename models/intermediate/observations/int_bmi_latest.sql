{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Latest BMI Observations - Most recent valid BMI measurement per person.

Clinical Purpose:
â€¢ Provides current BMI status for obesity management and clinical decision-making
â€¢ Supports weight management programme eligibility and QOF reporting
â€¢ Enables current health status assessment and risk stratification

Data Granularity:
â€¢ One row per person with their most recent valid BMI
â€¢ Includes only patients with valid BMI measurements
â€¢ Filtered to exclude implausible values for clinical accuracy

Key Features:
â€¢ Latest valid BMI identification using comprehensive filtering
â€¢ Clinical BMI categorisation with obesity class classification
â€¢ Data quality assurance with validation flags
â€¢ Complete observation metadata for clinical context

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
Latest valid BMI measurement per person.
Uses the comprehensive int_bmi_all model and filters to most recent valid BMI.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    bmi_value,
    concept_code,
    concept_display,
    source_cluster_id,
    bmi_category,
    original_result_value,
    is_valid_bmi

FROM (
    {{ get_latest_events(
        ref('int_bmi_all'),
        partition_by=['person_id'],
        order_by=['clinical_effective_date']
    ) }}
)
WHERE is_valid_bmi = TRUE
