version: 2

models:
  - name: int_retinal_screening_all
    description: |
      All diabetes retinal screening programme completions with enhanced analytics features.
      Uses RETSCREN_COD cluster which only includes completed screenings 
      (excludes declined, unsuitable, or referral codes).
      
      Enhanced Analytics Features:
      - Legacy structure alignment with sk_patient_id
      - Comprehensive screening result categorisation
      - Diabetes eye risk assessment and interpretation
      - Enhanced clinical context and timeframe analysis
      - QOF diabetes care process integration support
      
      Includes ALL persons (active, inactive, deceased) following intermediate layer principles.
    columns:
      - name: observation_id
        description: "Unique observation identifier"
        tests:
          - not_null
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
      - name: sk_patient_id
        description: "Surrogate key patient identifier for legacy compatibility"
      - name: clinical_effective_date
        description: "Date of the retinal screening"
        tests:
          - not_null
      - name: concept_code
        description: "SNOMED concept code for retinal screening"
        tests:
          - not_null
      - name: concept_display
        description: "Description of the screening code"
        tests:
          - not_null
      - name: source_cluster_id
        description: "Source cluster ID (RETSCREN_COD)"
        tests:
          - not_null
          - accepted_values:
              values: ['RETSCREN_COD']
      - name: is_completed_screening
        description: "Flag indicating completed screening (always TRUE)"
        tests:
          - not_null
          - accepted_values:
              values: [true]
      - name: is_retinal_screening_code
        description: "Flag indicating retinal screening code (always TRUE)"
        tests:
          - not_null
          - accepted_values:
              values: [true]
      - name: screening_result_category
        description: "Enhanced screening result categorisation"
        tests:
          - not_null
          - accepted_values:
              values: ['Normal', 'Background Retinopathy', 'Pre-proliferative', 'Proliferative', 'Maculopathy', 'Referral Required', 'Screening Completed']
      - name: diabetes_eye_risk_category
        description: "Diabetes eye risk assessment based on screening results"
        tests:
          - not_null
          - accepted_values:
              values: ['Low Risk (Normal)', 'Low-Moderate Risk (Background)', 'Moderate Risk (Pre-proliferative)', 'High Risk (Sight-threatening)', 'Requires Clinical Assessment', 'Risk Assessment Required']
      - name: is_normal_screening
        description: "Flag indicating normal screening result"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: is_sight_threatening_retinopathy
        description: "Flag indicating sight-threatening retinopathy"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: requires_ophthalmology_referral
        description: "Flag indicating ophthalmology referral required"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: days_since_screening
        description: "Number of days since screening"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 50000
              severity: warn
      - name: years_since_screening
        description: "Number of years since screening (decimal)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 150
              severity: warn
      - name: screening_current_12m
        description: "Flag indicating screening within 12 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: screening_current_24m
        description: "Flag indicating screening within 24 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: meets_qof_screening_requirement
        description: "Flag indicating screening meets QOF requirement (within 12 months)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      - name: screening_status_interpretation
        description: "Clinical interpretation of screening currency"
        tests:
          - not_null
          - accepted_values:
              values: ['Current (within 12 months)', 'Recent (within 24 months)', 'Overdue (>24 months)']

    tests:
      - test_cluster_ids_exist:
          cluster_ids: "RETSCREN_COD" 