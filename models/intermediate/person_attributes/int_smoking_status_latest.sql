{{
    config(
        materialized='table',
        cluster_by=['person_id'],
        post_hook=[
            "COMMENT ON TABLE {{ this }} IS 'Intermediate: Smoking Status Latest - Most recent smoking status per person for current clinical decision support and QOF reporting.

Clinical Purpose:
â€¢ Current smoking status determination for clinical decision support
â€¢ QOF smoking indicator extraction and cardiovascular risk assessment
â€¢ Real-time lifestyle intervention eligibility and patient safety protocols
â€¢ Smoking cessation programme targeting and health improvement tracking

Data Granularity:
â€¢ One row per person representing most recent smoking status observation
â€¢ Uses QOF cluster prioritisation for specific status codes
â€¢ Includes all persons regardless of status for comprehensive QOF reporting

Key Features:
â€¢ Latest smoking status with specific code prioritisation over general codes
â€¢ Current clinical decision support for CVD risk and intervention planning
â€¢ QOF-compliant smoking status determination for reporting
â€¢ Essential for real-time lifestyle intervention and patient safety protocols

ðŸ¤– Generated by dbt. This table is managed by dbt - for model definitions and documentation, see https://github.com/ncl-icb-analytics/snowflake-hei-migration'"
        ]
    )
}}

/*
Latest smoking status per person based on most recent smoking-related observation.
Uses QOF definitions and prioritises specific status codes over general smoking codes.
*/

SELECT
    person_id,
    observation_id,
    clinical_effective_date,
    concept_code,
    code_description,
    source_cluster_id,
    is_smoker_code,
    is_ex_smoker_code,
    is_never_smoked_code,
    smoking_status,
    is_current_smoker,
    is_ex_smoker

FROM (
    {{ get_latest_events(
        ref('int_smoking_status_all'),
        partition_by=['person_id'],
        order_by='clinical_effective_date'
    ) }}
) latest_smoking_status
