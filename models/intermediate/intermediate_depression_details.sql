CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_DEPRESSION_DETAILS (
    PERSON_ID VARCHAR, -- Unique identifier for the person
    SK_PATIENT_ID VARCHAR, -- Surrogate key for the patient
    AGE NUMBER, -- Age of the person

    EARLIEST_DEPRESSION_DATE DATE, -- Earliest depression diagnosis date
    LATEST_DEPRESSION_DATE DATE, -- Latest depression diagnosis date (DEPR_DAT)
    LATEST_DEPRESSION_RESOLVED_DATE DATE, -- Latest DEPRES_COD date, regardless of DEPR_COD dates

    EARLIEST_REVIEW_DATE DATE, -- Earliest depression review date within 10-56 days of diagnosis
    LATEST_REVIEW_DATE DATE, -- Latest depression review date within 10-56 days of diagnosis

    EARLIEST_INVITE_DATE DATE, -- Earliest depression review invitation date
    SECOND_INVITE_DATE DATE, -- Second depression review invitation date (at least 7 days after first)

    LATEST_PCA_DECLINE_DATE DATE, -- Latest date patient declined depression care
    LATEST_PCA_UNSUITABLE_DATE DATE, -- Latest date depression care was deemed unsuitable

    ALL_DEPRESSION_CONCEPT_CODES ARRAY, -- All depression concept codes
    ALL_DEPRESSION_CONCEPT_DISPLAYS ARRAY, -- All depression concept display terms
    ALL_DEPRESSION_RESOLVED_CONCEPT_CODES ARRAY, -- All depression resolved concept codes
    ALL_DEPRESSION_RESOLVED_CONCEPT_DISPLAYS ARRAY, -- All depression resolved concept display terms
    ALL_DEPRESSION_REVIEW_CONCEPT_CODES ARRAY, -- All depression review concept codes
    ALL_DEPRESSION_REVIEW_CONCEPT_DISPLAYS ARRAY, -- All depression review concept display terms
    ALL_DEPRESSION_INVITE_CONCEPT_CODES ARRAY, -- All depression invite concept codes
    ALL_DEPRESSION_INVITE_CONCEPT_DISPLAYS ARRAY, -- All depression invite concept display terms
    ALL_DEPRESSION_PCA_DECLINE_CONCEPT_CODES ARRAY, -- All depression PCA decline concept codes
    ALL_DEPRESSION_PCA_DECLINE_CONCEPT_DISPLAYS ARRAY, -- All depression PCA decline concept display terms
    ALL_DEPRESSION_PCA_UNSUITABLE_CONCEPT_CODES ARRAY, -- All depression PCA unsuitable concept codes
    ALL_DEPRESSION_PCA_UNSUITABLE_CONCEPT_DISPLAYS ARRAY -- All depression PCA unsuitable concept display terms
)
COMMENT = 'Intermediate table aggregating Depression related diagnoses (DEPR_COD, DEPRES_COD, DEPRVW_COD, DEPRINVITE_COD, DEPRPCADEC_COD, DEPRPCAPU_COD) for each person.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS

WITH BaseObservations AS (
    -- Get all diagnoses related to Depression, Depression Resolved, Reviews, Invites, and PCA decisions
    SELECT 
        PP."person_id" AS PERSON_ID,
        P."sk_patient_id" AS SK_PATIENT_ID,
        AGE.AGE,
        O."clinical_effective_date"::DATE AS CLINICAL_EFFECTIVE_DATE,
        MC.CONCEPT_CODE,
        MC.CODE_DESCRIPTION,
        MC.CLUSTER_ID
    FROM "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."OBSERVATION" AS O
    JOIN DATA_LAB_NCL_TRAINING_TEMP.CODESETS.MAPPED_CONCEPTS AS MC
        ON O."observation_core_concept_id" = MC.SOURCE_CODE_ID
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT_PERSON" AS PP
        ON O."patient_id" = PP."patient_id"
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT" AS P
        ON O."patient_id" = P."id"
    JOIN DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.DIM_PERSON_AGE AS AGE
        ON PP."person_id" = AGE.PERSON_ID
    WHERE MC.CLUSTER_ID IN ('DEPR_COD', 'DEPRES_COD', 'DEPRVW_COD', 'DEPRINVITE_COD', 'DEPRPCADEC_COD', 'DEPRPCAPU_COD')
),
ReviewDates AS (
    -- Calculate review dates that fall within 10-56 days of a depression diagnosis
    SELECT 
        bo.PERSON_ID,
        bo.CLINICAL_EFFECTIVE_DATE AS REVIEW_DATE,
        d.LATEST_DEPRESSION_DATE,
        CASE 
            WHEN bo.CLINICAL_EFFECTIVE_DATE BETWEEN 
                DATEADD(day, 10, d.LATEST_DEPRESSION_DATE) AND 
                DATEADD(day, 56, d.LATEST_DEPRESSION_DATE)
            THEN TRUE 
            ELSE FALSE 
        END AS IS_VALID_REVIEW
    FROM BaseObservations bo
    JOIN (
        SELECT 
            PERSON_ID,
            MAX(CASE WHEN CLUSTER_ID = 'DEPR_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS LATEST_DEPRESSION_DATE
        FROM BaseObservations
        GROUP BY PERSON_ID
    ) d ON bo.PERSON_ID = d.PERSON_ID
    WHERE bo.CLUSTER_ID = 'DEPRVW_COD'
),
InviteDates AS (
    -- Calculate first invite date
    SELECT
        PERSON_ID,
        MIN(CLINICAL_EFFECTIVE_DATE) AS FIRST_INVITE_DATE
    FROM BaseObservations
    WHERE CLUSTER_ID = 'DEPRINVITE_COD'
    GROUP BY PERSON_ID
),
SecondInvite AS (
    -- Calculate second invite date (at least 7 days after first)
    SELECT
        bo.PERSON_ID,
        MIN(bo.CLINICAL_EFFECTIVE_DATE) AS SECOND_INVITE_DATE
    FROM BaseObservations bo
    JOIN InviteDates id
      ON bo.PERSON_ID = id.PERSON_ID
     AND bo.CLUSTER_ID = 'DEPRINVITE_COD'
     AND bo.CLINICAL_EFFECTIVE_DATE > DATEADD(day, 7, id.FIRST_INVITE_DATE)
    GROUP BY bo.PERSON_ID
)
SELECT
    bo.PERSON_ID,
    bo.SK_PATIENT_ID,
    bo.AGE,

    -- Depression diagnosis dates
    MIN(CASE WHEN bo.CLUSTER_ID = 'DEPR_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_DEPRESSION_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'DEPR_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_DEPRESSION_DATE,
    
    -- Depression resolved date
    MAX(CASE WHEN bo.CLUSTER_ID = 'DEPRES_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_DEPRESSION_RESOLVED_DATE,

    -- Review dates (only those within 10-56 days of latest diagnosis)
    MIN(CASE WHEN rd.IS_VALID_REVIEW THEN rd.REVIEW_DATE END) AS EARLIEST_REVIEW_DATE,
    MAX(CASE WHEN rd.IS_VALID_REVIEW THEN rd.REVIEW_DATE END) AS LATEST_REVIEW_DATE,

    -- Invite dates
    id.FIRST_INVITE_DATE AS EARLIEST_INVITE_DATE,
    si.SECOND_INVITE_DATE AS SECOND_INVITE_DATE,

    -- PCA decision dates
    MAX(CASE WHEN bo.CLUSTER_ID = 'DEPRPCADEC_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_PCA_DECLINE_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'DEPRPCAPU_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_PCA_UNSUITABLE_DATE,

    -- Concept code arrays
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPR_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPR_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRES_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_RESOLVED_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRES_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_RESOLVED_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRVW_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_REVIEW_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRVW_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_REVIEW_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRINVITE_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_INVITE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRINVITE_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_INVITE_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRPCADEC_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_PCA_DECLINE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRPCADEC_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_PCA_DECLINE_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRPCAPU_COD' THEN bo.CONCEPT_CODE END) AS ALL_DEPRESSION_PCA_UNSUITABLE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'DEPRPCAPU_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_DEPRESSION_PCA_UNSUITABLE_CONCEPT_DISPLAYS
FROM BaseObservations bo
LEFT JOIN ReviewDates rd ON bo.PERSON_ID = rd.PERSON_ID
LEFT JOIN InviteDates id ON bo.PERSON_ID = id.PERSON_ID
LEFT JOIN SecondInvite si ON bo.PERSON_ID = si.PERSON_ID
GROUP BY 
    bo.PERSON_ID, 
    bo.SK_PATIENT_ID, 
    bo.AGE,
    id.FIRST_INVITE_DATE,
    si.SECOND_INVITE_DATE; 