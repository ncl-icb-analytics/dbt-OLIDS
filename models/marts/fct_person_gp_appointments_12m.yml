version: 2

models:
  - name: fct_person_gp_appointments_12m
    description: |
      GP appointments 12-month fact table providing service usage metrics.
      
      **Business Logic:**
      - Counts GP appointments per person per organisation in last 12 months
      - Aggregates from appointment start date
      - Includes all appointment types
      
      **Population Coverage:**
      ALL persons with appointments in the last 12 months.
      Includes active, inactive, and deceased for comprehensive service analytics.
      
      **Service Context:**
      Supports capacity planning, utilisation analysis, and patient access monitoring.
      Key metric for primary care service delivery assessment.

    config:
      materialized: table
      
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id
            - organisation_id
    
    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person')
              field: person_id
              
      - name: organisation_id
        description: "Organisation providing the appointments"
        tests:
          - not_null
          
      - name: measure_id
        description: "Metric identifier (always 'GP_APPOINTMENTS_12M')"
        tests:
          - not_null
          - accepted_values:
              values: ['GP_APPOINTMENTS_12M']
              
      - name: appointment_count
        description: "Number of GP appointments in last 12 months"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              
      - name: earliest_appointment_date
        description: "Date of earliest appointment in the 12-month period"
        tests:
          - not_null
          
      - name: latest_appointment_date
        description: "Date of most recent appointment in the 12-month period"
        tests:
          - not_null
          
      - name: age
        description: "Person's current age in years"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 120 