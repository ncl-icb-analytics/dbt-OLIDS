version: 2

models:
  - name: dim_households
    description: >
      Household dimension representing physical dwellings identified by deterministic UPRN hash.
      Focuses purely on dwelling properties and geographic context, not on who lives there.
      For household composition and member details, see fct_household_members.

    columns:
      - name: household_id
        description: "Unique surrogate key for the household (generated from uprn_hash)"
        tests:
          - unique
          - not_null

      - name: uprn_hash
        description: "Hashed UPRN - deterministic identifier for the physical dwelling"
        tests:
          - unique
          - not_null

      - name: dwelling_activity_status
        description: "Classification of recent activity at this dwelling"
        tests:
          - not_null
          - accepted_values:
              values: ['Recently active', 'Previously active', 'Historically active only']

      - name: years_since_first_occupation
        description: "Number of years since first known occupation of this dwelling"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: first_known_occupation_date
        description: "Earliest known registration date for any person at this dwelling"
        tests:
          - not_null

      - name: last_known_activity_date
        description: "Most recent registration activity date for this dwelling"
        tests:
          - not_null

      - name: lsoa_code_21
        description: "Lower Super Output Area code (2021 boundaries)"

      - name: lsoa_name_21
        description: "Lower Super Output Area name (2021 boundaries)"

      - name: imd_decile_19
        description: "Index of Multiple Deprivation decile (2019)"
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 10

      - name: imd_quintile_19
        description: "Index of Multiple Deprivation quintile (2019)"
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 5

      - name: created_at
        description: "Timestamp when this record was created"
        tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          name: "last_activity_after_first_occupation"
          expression: "last_known_activity_date >= first_known_occupation_date"

      - dbt_utils.at_least_one:
          name: "has_at_least_one_dwelling"
          column_name: household_id  # Check the table has at least one row
