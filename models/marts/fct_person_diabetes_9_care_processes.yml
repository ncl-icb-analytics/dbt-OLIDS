version: 2

models:
  - name: fct_person_diabetes_9_care_processes
    description: |
      Fact table tracking completion of the 9 diabetes care processes for people on the diabetes register.
      
      **9 Care Processes (8 standard + retinal screening):**
      1. HbA1c test
      2. Blood pressure check
      3. Cholesterol test
      4. Serum creatinine test
      5. Urine ACR test
      6. Foot examination
      7. BMI recording
      8. Smoking status recording
      9. Retinal screening
      
      **Business Logic:**
      - Extends fct_person_diabetes_8_care_processes with retinal screening data
      - Completion timeframe: Within last 12 months from current date
      - Includes both 8-process and 9-process completion metrics
      - Maintains all original 8-process business logic
      
      **Clinical Context:**
      Comprehensive diabetes quality monitoring including diabetic retinopathy screening.
      Essential for full diabetes care pathway assessment and QOF reporting.
    
    tests:
      - not_null:
          column_name: person_id
      - not_null:
          column_name: sk_patient_id
      - dbt_utils.accepted_range:
          column_name: care_processes_8_completed
          min_value: 0
          max_value: 8
      - dbt_utils.accepted_range:
          column_name: care_processes_9_completed
          min_value: 0
          max_value: 9
    
    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('fct_person_diabetes_8_care_processes')
              field: person_id
      
      - name: sk_patient_id
        description: "Surrogate key for the patient"
        tests:
          - not_null
      
      # Inherited from 8 care processes - core measurements
      - name: latest_hba1c_date
        description: "Date of most recent HbA1c test"
        tests:
          - dbt_utils.not_future_date
      
      - name: hba1c_completed_in_last_12m
        description: "TRUE if HbA1c test completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_hba1c_value
        description: "Most recent HbA1c result value (mmol/mol or %)"
        tests:
          - dbt_utils.accepted_range:
              min_value: 20
              max_value: 200
              severity: warn
      
      - name: latest_bp_date
        description: "Date of most recent blood pressure reading"
        tests:
          - dbt_utils.not_future_date
      
      - name: bp_completed_in_last_12m
        description: "TRUE if blood pressure check completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_cholesterol_date
        description: "Date of most recent total cholesterol test"
        tests:
          - dbt_utils.not_future_date
      
      - name: cholesterol_completed_in_last_12m
        description: "TRUE if cholesterol test completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_creatinine_date
        description: "Date of most recent serum creatinine test"
        tests:
          - dbt_utils.not_future_date
      
      - name: creatinine_completed_in_last_12m
        description: "TRUE if serum creatinine test completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_acr_date
        description: "Date of most recent urine ACR test"
        tests:
          - dbt_utils.not_future_date
      
      - name: acr_completed_in_last_12m
        description: "TRUE if urine ACR test completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_foot_check_date
        description: "Date of most recent foot examination"
        tests:
          - dbt_utils.not_future_date
      
      - name: foot_check_completed_in_last_12m
        description: "TRUE if foot examination completed within last 12 months with quality criteria met"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_bmi_date
        description: "Date of most recent BMI recording"
        tests:
          - dbt_utils.not_future_date
      
      - name: bmi_completed_in_last_12m
        description: "TRUE if BMI recorded within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      - name: latest_smoking_date
        description: "Date of most recent smoking status recording"
        tests:
          - dbt_utils.not_future_date
      
      - name: smoking_completed_in_last_12m
        description: "TRUE if smoking status recorded within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      # 9th care process - retinal screening
      - name: latest_retinal_screening_date
        description: "Date of most recent retinal screening"
        tests:
          - dbt_utils.not_future_date
      
      - name: retinal_screening_completed_in_last_12m
        description: "TRUE if retinal screening completed within last 12 months"
        tests:
          - accepted_values:
              values: [true, false]
      
      # Completion metrics
      - name: care_processes_8_completed
        description: "Count of original 8 care processes completed within last 12 months (0-8)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 8
      
      - name: care_processes_9_completed
        description: "Count of all 9 care processes completed within last 12 months (0-9)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 9
      
      - name: all_8_processes_completed
        description: "TRUE if all original 8 care processes completed within last 12 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      
      - name: all_9_processes_completed
        description: "TRUE if all 9 care processes completed within last 12 months"
        tests:
          - not_null
          - accepted_values:
              values: [true, false] 