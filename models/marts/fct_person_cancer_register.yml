version: 2

models:
  - name: fct_person_cancer_register
    description: |
      **Cancer Register - QOF Quality Measures**
      
      Fact table for cancer register with date filter. All patients with cancer diagnosis 
      on/after April 1, 2003 are included on the register.
      
      Simple Register Business Logic with Date Filter:
      - Cancer diagnosis on/after 1 April 2003 = on register
      - No resolution codes (cancer is permanent)
      - No age restrictions
      - Excludes non-melanotic skin cancers (handled in cluster definition)
      
      QOF Context:
      Used for cancer care quality measures including:
      - Survivorship care and follow-up monitoring
      - Cancer care pathway tracking
      - Treatment outcome monitoring
      - Care coordination quality measures
      
      Note: Legacy includes episode timing flags, but keeping this model simple 
      per architectural guidance. Episode analysis can be done separately if needed.
      
      Matches legacy fct_person_dx_cancer business logic and field structure.
      
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id

    columns:
      - name: person_id
        description: "Unique person identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_person')
              field: person_id

      - name: sk_patient_id
        description: "Surrogate key for the patient (from EMIS system)"
        tests:
          - not_null

      - name: age
        description: "Current age of person in years"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 120

      - name: is_on_cancer_register
        description: "Register flag: has cancer diagnosis on/after 1 April 2003 (always TRUE for this table)"
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: earliest_cancer_date
        description: "Date of first recorded cancer diagnosis"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "<= latest_cancer_date"
          - dbt_utils.expression_is_true:
              expression: ">= '2003-04-01'"

      - name: latest_cancer_date
        description: "Date of most recent cancer diagnosis"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= earliest_cancer_date"
          - dbt_utils.expression_is_true:
              expression: "<= current_date()"
          - dbt_utils.expression_is_true:
              expression: ">= '2003-04-01'"

      - name: all_cancer_concept_codes
        description: "Array of all distinct cancer concept codes for this person"
        tests:
          - not_null

      - name: all_cancer_concept_displays
        description: "Array of all distinct cancer concept display terms for this person"
        tests:
          - not_null 