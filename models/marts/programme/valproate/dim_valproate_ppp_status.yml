version: 2
models:
- name: dim_valproate_ppp_status
  description: 'Person-level aggregation of Pregnancy Prevention Programme (PPP) events for valproate monitoring.

    Business Logic:
    
    • Aggregates all PPP events per person from intermediate PPP status table
    
    • Determines latest PPP status and enrollment (is_currently_ppp_enrolled from most recent event)
    
    • Includes arrays of all observation IDs, concept codes, and displays for traceability
    
    • Provides current PPP status description with formatted date
    
    • Only includes people who have PPP events (has_ppp_event always TRUE)'
  columns:
  - name: person_id
    description: Unique identifier for the person.
    tests:
    - not_null
    - unique
  - name: has_ppp_event
    description: TRUE if any PPP event is present for the person.
    tests:
    - not_null
  - name: earliest_ppp_event_date
    description: Earliest date of any PPP-related event for the person.
  - name: latest_ppp_event_date
    description: Latest date of any PPP-related event for the person.
  - name: latest_ppp_observation_id
    description: Observation ID for the most recent PPP event.
  - name: latest_ppp_concept_code
    description: Medical concept code for the most recent PPP event.
  - name: latest_ppp_concept_display
    description: Display term for the most recent PPP concept code.
  - name: is_currently_ppp_enrolled
    description: TRUE if most recent PPP status indicates enrollment.
    tests:
    - not_null
  - name: is_ppp_non_enrolled
    description: TRUE if most recent PPP status indicates discontinued/not needed/declined.
    tests:
    - not_null
  - name: current_ppp_status_description
    description: Human-readable description of current PPP status.
  - name: current_ppp_status_with_date
    description: PPP status description concatenated with formatted date.
  - name: all_ppp_observation_ids
    description: Array of unique observation IDs related to PPP events.
  - name: all_ppp_concept_codes
    description: Array of all distinct PPP-related medical concept codes found.
  - name: all_ppp_concept_displays
    description: Array of display terms for the PPP codes.
  - name: all_ppp_code_categories_applied
    description: Array of code categories applied (will contain various PPP categories).
