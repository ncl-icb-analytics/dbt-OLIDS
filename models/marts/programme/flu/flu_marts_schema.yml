version: 2

models:
  - name: fct_flu_eligibility
    description: 'Flu Vaccination Eligibility Fact Table - Who SHOULD be vaccinated

      This model determines eligibility for flu vaccination using clear, individual rule models.

      Business Logic:

      • Consolidates all flu vaccination eligibility rules using campaign-agnostic approach

      • Age-based rules (65+, preschool, school age), clinical conditions, and special populations

      • Works with any campaign year via flu_current_campaign variable in dbt_project.yml

      • One row per person per eligible rule group with priority-based classification'

    columns:
      - name: campaign_id
        description: 'Campaign identifier (e.g., flu_2024_25). Set via dbt_project.yml variable.'
        tests:
          - not_null
      - name: rule_group_id
        description: 'Rule group identifier (e.g., OVER65_GROUP, CHILD_PRESCHOOL, CHD_GROUP)'
        tests:
          - not_null
      - name: rule_group_name
        description: 'Human-readable rule group name for reporting'
        tests:
          - not_null
      - name: rule_type
        description: 'Classification of rule logic type for analysis'
        tests:
          - not_null
          - accepted_values:
              values: ['AGE_BASED', 'CLINICAL_CONDITION', 'COMBINATION', 'HIERARCHICAL', 'EXCLUSION', 'SOCIAL_FACTOR']
      - name: person_id
        description: 'Person identifier linking to demographic data'
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: qualifying_event_date
        description: 'Date of qualifying clinical event (NULL for age-based rules)'
      - name: reference_date
        description: 'Campaign reference date used for eligibility determination'
        tests:
          - not_null
      - name: eligibility_reason
        description: 'Human-readable description of why person is eligible'
        tests:
          - not_null
      - name: birth_date_approx
        description: 'Person birth date from demographics'
        tests:
          - not_null
      - name: age_months
        description: 'Age in months at reference date'
        tests:
          - not_null
      - name: age_years
        description: 'Age in years at reference date'
        tests:
          - not_null
      - name: eligibility_priority
        description: 'Priority ranking for multiple eligibilities (1=highest)'
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5]
      - name: created_at
        description: 'Timestamp when record was created'
        tests:
          - not_null

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [campaign_id, person_id, rule_group_id]
          name: unique_person_campaign_rule_combination
      - dbt_utils.expression_is_true:
          expression: "age_years >= 0 AND age_years <= 120"
          name: reasonable_age_range
      - dbt_utils.expression_is_true:
          expression: "qualifying_event_date IS NULL OR qualifying_event_date <= created_at"
          name: qualifying_event_before_created_date
      - dbt_utils.at_least_one:
          column_name: person_id
          name: has_at_least_one_eligible_person

  - name: fct_flu_status
    description: 'Flu Vaccination Status Fact Table - Who HAS BEEN vaccinated

      This model tracks vaccination outcomes and status using clear tracking models.

      Business Logic:

      • Tracks vaccination administration, declination, and LAIV records

      • Separate from eligibility - focuses on actual vaccination outcomes

      • Works with any campaign year via flu_current_campaign variable

      • One row per person per vaccination status type with outcome tracking'

    columns:
      - name: campaign_id
        description: 'Campaign identifier (e.g., flu_2024_25)'
        tests:
          - not_null
      - name: campaign_name
        description: 'Human-readable campaign name'
        tests:
          - not_null
      - name: rule_group_id
        description: 'Status tracking group identifier'
        tests:
          - not_null
      - name: rule_group_name
        description: 'Human-readable status tracking name'
        tests:
          - not_null
      - name: person_id
        description: 'Person identifier'
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: status_date
        description: 'Date when vaccination status was recorded'
      - name: reference_date
        description: 'Campaign reference date'
        tests:
          - not_null
      - name: status_reason
        description: 'Description of vaccination status/outcome'
        tests:
          - not_null
      - name: status_type
        description: 'Type of vaccination status'
        tests:
          - not_null
          - accepted_values:
              values: ['VACCINATION_ADMINISTERED', 'LAIV_ADMINISTERED', 'VACCINATION_DECLINED']
      - name: birth_date_approx
        description: 'Person birth date'
        tests:
          - not_null
      - name: age_months
        description: 'Age in months at reference date'
        tests:
          - not_null
      - name: age_years
        description: 'Age in years at reference date'
        tests:
          - not_null
      - name: created_at
        description: 'Record creation timestamp'
        tests:
          - not_null

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [campaign_id, person_id, rule_group_id]
          name: unique_person_campaign_status_combination

  - name: fct_flu_eligibility_comparison
    description: 'Multi-campaign comparison view for year-over-year analysis

      Uses the campaign-agnostic fct_flu_eligibility model for consistent comparisons.

      Business Logic:

      • Enables comparison between campaigns using standardised approach

      • Summary statistics by campaign, rule group, and age demographics

      • Simple view-based approach rather than complex unions'

    columns:
      - name: campaign_id
        description: 'Campaign identifier for comparison'
        tests:
          - not_null
      - name: rule_group_id
        description: 'Rule group for comparison analysis'
        tests:
          - not_null
      - name: rule_group_name
        description: 'Rule group name for reporting'
        tests:
          - not_null
      - name: rule_type
        description: 'Rule type classification'
        tests:
          - not_null
      - name: eligible_people
        description: 'Count of eligible people in this group'
        tests:
          - not_null
      - name: min_age
        description: 'Minimum age in this eligibility group'
      - name: max_age
        description: 'Maximum age in this eligibility group'
      - name: avg_age
        description: 'Average age in this eligibility group'

    tests:
      - dbt_utils.at_least_one:
          column_name: eligible_people
          name: has_eligible_people_in_comparison

  - name: fct_flu_uptake
    description: 'Flu Vaccination Uptake Fact Table (Row-Level)

      Combines eligibility and vaccination status at person level for comprehensive uptake analysis.

      Business Logic:

      • Joins eligibility data with vaccination status to show complete uptake picture

      • Includes practice and demographic information for segmentation

      • Identifies coverage gaps and vaccination patterns

      • Works automatically with both current and previous campaigns'

    columns:
      - name: campaign_id
        description: 'Campaign identifier'
        tests:
          - not_null
      - name: person_id
        description: 'Person identifier'
        tests:
          - not_null
          - relationships:
              to: ref('dim_person_demographics')
              field: person_id
      - name: practice_code
        description: 'GP practice code'
      - name: practice_name
        description: 'GP practice name'
      - name: pcn_code
        description: 'Primary Care Network code'
      - name: pcn_name
        description: 'Primary Care Network name'
      - name: practice_borough
        description: 'Borough where practice is located'
      - name: is_eligible
        description: 'Whether person is eligible for flu vaccination'
        tests:
          - not_null
      - name: vaccination_status
        description: 'Current vaccination status'
      - name: vaccinated
        description: 'Whether person has been vaccinated'
        tests:
          - not_null
      - name: declined
        description: 'Whether person declined vaccination'
        tests:
          - not_null
      - name: eligible_no_record
        description: 'Eligible but has no vaccination record'
        tests:
          - not_null
      - name: uptake_category
        description: 'Combined eligibility and vaccination status category'
        tests:
          - not_null
          - accepted_values:
              values: ['Eligible - Vaccinated', 'Eligible - Declined', 'Eligible - No Record', 
                       'Not Eligible - Vaccinated', 'Not Eligible - Declined', 'Not Eligible - No Activity']

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [campaign_id, person_id]
          name: unique_person_campaign_uptake

  - name: fct_flu_uptake_by_practice
    description: 'Flu Vaccination Uptake by Practice (Aggregated)

      Aggregates flu vaccination uptake at practice level for performance monitoring.

      Business Logic:

      • Calculates uptake rates, coverage gaps, and demographic breakdowns by practice

      • Includes time-to-vaccination metrics and performance indicators

      • Enables comparison across PCNs, boroughs, and campaigns

      • Identifies practices needing targeted interventions'

    columns:
      - name: campaign_id
        description: 'Campaign identifier'
        tests:
          - not_null
      - name: practice_code
        description: 'GP practice code'
        tests:
          - not_null
      - name: practice_name
        description: 'GP practice name'
        tests:
          - not_null
      - name: eligible_population
        description: 'Total eligible population at practice'
        tests:
          - not_null
      - name: eligible_vaccinated
        description: 'Number of eligible people vaccinated'
        tests:
          - not_null
      - name: uptake_rate
        description: 'Vaccination uptake rate (percentage)'
      - name: coverage_gap
        description: 'Number of eligible people not vaccinated'
        tests:
          - not_null
      - name: uptake_performance
        description: 'Performance category based on uptake rate'
        tests:
          - not_null
          - accepted_values:
              values: ['High', 'Medium', 'Low', 'Very Low']

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [campaign_id, practice_code]
          name: unique_practice_campaign_uptake