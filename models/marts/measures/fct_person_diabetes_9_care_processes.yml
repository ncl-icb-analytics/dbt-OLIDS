version: 2
models:
- name: fct_person_diabetes_9_care_processes
  description: 'Fact table tracking completion of the 9 diabetes care processes for people on the diabetes register.


    **9 Care Processes (8 standard + retinal screening):**

    1. HbA1c test

    2. Blood pressure check

    3. Cholesterol test

    4. Serum creatinine test

    5. Urine ACR test

    6. Foot examination

    7. BMI recording

    8. Smoking status recording

    9. Retinal screening


    **Business Logic:**

    - Extends fct_person_diabetes_8_care_processes with retinal screening data

    - Completion timeframe: Within last 12 months from current date

    - Includes both 8-process and 9-process completion metrics

    - Maintains all original 8-process business logic


    **Clinical Context:**

    Comprehensive diabetes quality monitoring including diabetic retinopathy screening.

    Essential for full diabetes care pathway assessment and QOF reporting.

    '
  columns:
  - name: person_id
    description: Unique person identifier
    tests:
    - not_null
    - relationships:
        to: ref('fct_person_diabetes_8_care_processes')
        field: person_id
  - name: latest_hba1c_date
    description: Date of most recent HbA1c test
    tests:
    - test_no_future_dates
  - name: hba1c_completed_in_last_12m
    description: TRUE if HbA1c test completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_hba1c_value
    description: Most recent HbA1c result value (mmol/mol or %)
    tests:
    - dbt_utils.accepted_range:
        min_value: 10
        max_value: 300
        severity: warn
  - name: latest_bp_date
    description: Date of most recent blood pressure reading
    tests:
    - test_no_future_dates
  - name: bp_completed_in_last_12m
    description: TRUE if blood pressure check completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_cholesterol_date
    description: Date of most recent total cholesterol test
    tests:
    - test_no_future_dates
  - name: cholesterol_completed_in_last_12m
    description: TRUE if cholesterol test completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_creatinine_date
    description: Date of most recent serum creatinine test
    tests:
    - test_no_future_dates
  - name: creatinine_completed_in_last_12m
    description: TRUE if serum creatinine test completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_acr_date
    description: Date of most recent urine ACR test
    tests:
    - test_no_future_dates
  - name: acr_completed_in_last_12m
    description: TRUE if urine ACR test completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_foot_check_date
    description: Date of most recent foot examination
    tests:
    - test_no_future_dates
  - name: foot_check_completed_in_last_12m
    description: TRUE if foot examination completed within last 12 months with quality criteria met
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_bmi_date
    description: Date of most recent BMI recording
    tests:
    - test_no_future_dates
  - name: bmi_completed_in_last_12m
    description: TRUE if BMI recorded within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_smoking_date
    description: Date of most recent smoking status recording
    tests:
    - test_no_future_dates
  - name: smoking_completed_in_last_12m
    description: TRUE if smoking status recorded within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: latest_retinal_screening_date
    description: Date of most recent retinal screening
    tests:
    - test_no_future_dates
  - name: retinal_screening_completed_in_last_12m
    description: TRUE if retinal screening completed within last 12 months
    tests:
    - accepted_values:
        values:
        - true
        - false
  - name: care_processes_8_completed
    description: Count of original 8 care processes completed within last 12 months (0-8)
    tests:
    - not_null
    - dbt_utils.accepted_range:
        min_value: 0
        max_value: 8
  - name: care_processes_9_completed
    description: Count of all 9 care processes completed within last 12 months (0-9)
    tests:
    - not_null
    - dbt_utils.accepted_range:
        min_value: 0
        max_value: 9
  - name: all_8_processes_completed
    description: TRUE if all original 8 care processes completed within last 12 months
    tests:
    - not_null
    - accepted_values:
        values:
        - true
        - false
  - name: all_9_processes_completed
    description: TRUE if all 9 care processes completed within last 12 months
    tests:
    - not_null
    - accepted_values:
        values:
        - true
        - false
