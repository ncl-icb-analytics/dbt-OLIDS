version: 2

models:
  - name: dim_person_active_patients
    description: |
      Dimension table providing active patient status at person level using proper registration data
      from episode_of_care. Filters to only include currently active patients, excluding deceased
      patients and dummy patients.
      
      **Active Patient Criteria:**
      - Has current practice registration (via episode_of_care)
      - Not deceased (death_year IS NULL)
      - Not a dummy/test patient
      
      **Registration Logic:**
      - Uses int_patient_registrations for current practice details
      - Includes registration history metadata
      - One row per active person
      
      **Key Usage:**
      - Primary filter for active patient populations
      - Practice-level patient analysis
      - Current registration reporting
      
    columns:
      - name: person_id
        description: "Unique person identifier - primary key"
        tests:
          - not_null
          - unique

      - name: sk_patient_id
        description: "Surrogate patient key from latest patient record"
        tests:
          - not_null

      - name: primary_patient_id
        description: "Primary patient ID from person record"

      - name: patient_ids
        description: "Array of all patient IDs associated with this person"
        tests:
          - not_null

      - name: is_active
        description: "Boolean flag - always TRUE for this table (filtered to active only)"
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: is_deceased
        description: "Boolean flag - always FALSE for this table (deceased patients excluded)"
        tests:
          - not_null
          - accepted_values:
              values: [false]

      - name: is_dummy_patient
        description: "Boolean flag - always FALSE for this table (dummy patients excluded)"
        tests:
          - not_null
          - accepted_values:
              values: [false]

      - name: is_confidential
        description: "Boolean flag indicating if patient record is marked confidential"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: is_spine_sensitive
        description: "Boolean flag indicating if patient is spine sensitive"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: birth_year
        description: "Year of birth (YYYY format)"
        tests:
          - accepted_range:
              min_value: 1900
              max_value: 2030

      - name: birth_month
        description: "Month of birth (1-12)"
        tests:
          - accepted_range:
              min_value: 1
              max_value: 12

      - name: death_year
        description: "Year of death - always NULL for active patients"

      - name: death_month
        description: "Month of death - always NULL for active patients"

      - name: current_practice_id
        description: "Practice ID where patient is currently registered"
        tests:
          - not_null

      - name: current_practice_code
        description: "Practice ODS code where patient is currently registered"
        tests:
          - not_null

      - name: current_practice_name
        description: "Practice name where patient is currently registered"
        tests:
          - not_null

      - name: current_registration_start
        description: "Start date of current practice registration"
        tests:
          - not_null

      - name: current_registration_duration
        description: "Duration in days of current registration"
        tests:
          - accepted_range:
              min_value: 0
              max_value: 50000

      - name: total_registrations_count
        description: "Total number of practice registrations for this person"
        tests:
          - not_null
          - accepted_range:
              min_value: 1
              max_value: 50

      - name: has_changed_practice
        description: "Boolean flag indicating if person has ever changed practice"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: care_manager_practitioner_id
        description: "ID of care manager practitioner (if assigned)"

      - name: record_owner_org_code
        description: "Organisation code that owns this patient record"

      - name: latest_record_date
        description: "Timestamp of latest patient record update"
        tests:
          - not_null 