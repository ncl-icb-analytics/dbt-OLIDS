version: 2
models:
- name: fct_person_depression_register
  description: "**Depression Register - QOF Mental Health Quality Measures**\n
    \ + resolution logic.\n\nQOF Business Logic:\n- Age \u226518 years (QOF requirement)\n- Latest depression episode on/after\
    \ 1 April 2006 (QOF date threshold)\n- Unresolved: latest_diagnosis_date > latest_resolved_date OR no resolved code\n\
    - Includes ALL persons (active, inactive, deceased) for comprehensive reporting\n\nQOF Context:\nUsed for depression quality\
    \ measures including:\n- Depression care pathways and treatment monitoring\n- Recovery planning and review scheduling\n\
    - Psychological therapy access monitoring\n- Medication management and compliance"
  columns:
  - name: person_id
    description: Unique person identifier
    tests:
    - not_null
    - relationships:
        to: ref('dim_person')
        field: person_id
#   - name: age
#     description: Current age of person in years
#     tests:
#     - dbt_utils.accepted_range:
#         min_value: 18
#         max_value: 120
  - name: is_on_register
    description: 'Register flag: meets QOF depression criteria (always TRUE for this table)'
    tests:
    - not_null
    - accepted_values:
        values:
        - true
  - name: earliest_diagnosis_date
    description: Date of first recorded depression diagnosis
    tests:
    - not_null
    - test_no_future_dates
  - name: latest_diagnosis_date
    description: Date of most recent depression diagnosis (QOF requires on/after 1 April 2006)
    tests:
    - not_null
    - test_no_future_dates
    - dbt_utils.accepted_range:
        min_value: '''2006-04-01'''
        max_value: current_date()
        severity: warn
  - name: latest_depression_resolved_date
    description: Date of most recent depression resolved code (NULL if never resolved)
  - name: all_depression_concept_codes
    description: Array of all distinct depression diagnosis concept codes for this person
    tests:
    - not_null
  - name: all_depression_concept_displays
    description: Array of all distinct depression diagnosis concept display terms for this person
    tests:
    - not_null
  - name: all_depression_resolved_concept_codes
    description: Array of all distinct depression resolved concept codes for this person
  - name: all_depression_resolved_concept_displays
    description: Array of all distinct depression resolved concept display terms for this person
