models:
- name: fct_person_diabetes_register
  description: 'QOF Diabetes Register - Patients aged 17+ with active diabetes diagnosis including type classification.


    Population Scope:

    • Age 17+ years

    • Active diabetes diagnosis: latest DM_COD > latest DMRES_COD

    • Type classification: Type 1, Type 2, or Unknown (Type 1 takes precedence)

    • One row per person with current register status'

  columns:
  - name: person_id
    description: Unique person identifier across the HEI system

    tests:
    - not_null
    - unique
  - name: is_on_register
    description: QOF register inclusion flag - TRUE for all persons in this table

    tests:
    - not_null
    - accepted_values:

        values:
        - true
  - name: diabetes_type
    description: Classified diabetes type based on latest specific coding (Type 1 takes precedence)

    tests:
    - not_null
    - accepted_values:

        values:
        - Type 1
        - Type 2
        - Unknown
  - name: earliest_diagnosis_date
    description: Date of first recorded diabetes diagnosis code (any type)

    tests:
    - dbt_utils.not_accepted_values:

        values:
        - '1900-01-01'
  - name: latest_diagnosis_date
    description: Date of most recent diabetes diagnosis code (any type)

    tests:
    - not_null
  - name: latest_resolved_date
    description: Date of most recent diabetes resolved code (DMRES_COD) - NULL if never resolved
  - name: earliest_type1_date
    description: Date of first recorded Type 1 diabetes diagnosis code (DMTYPE1_COD)
  - name: latest_type1_date
    description: Date of most recent Type 1 diabetes diagnosis code (DMTYPE1_COD)
  - name: earliest_type2_date
    description: Date of first recorded Type 2 diabetes diagnosis code (DMTYPE2_COD)
  - name: latest_type2_date
    description: Date of most recent Type 2 diabetes diagnosis code (DMTYPE2_COD)
  - name: all_diabetes_concept_codes
    description: Array of all diabetes diagnosis concept codes recorded for this person
  - name: all_diabetes_concept_displays
    description: Array of all diabetes diagnosis concept display terms
  - name: all_type1_concept_codes
    description: Array of all Type 1 diabetes concept codes
  - name: all_type2_concept_codes
    description: Array of all Type 2 diabetes concept codes
  - name: all_resolved_concept_codes
    description: Array of all diabetes resolved concept codes
  - name: meets_age_criteria
    description: 'Boolean flag: TRUE if person meets age ≥17 requirement'

    tests:

    - not_null

    - accepted_values:

        values:

        - true

  - name: has_active_diabetes_diagnosis
    description: 'Boolean flag: TRUE if latest diagnosis > latest resolution (or no resolution)'

    tests:
    - not_null
    - accepted_values:

        values:
        - true
