models:
  - name: fct_person_atrial_fibrillation_register
    description: |
      QOF Atrial Fibrillation Register - Standard QOF register with resolution logic.
      
      **Business Logic (Pattern 2):**
      - Active AF diagnosis: latest AFIB_COD > latest AFIBRES_COD OR no resolution recorded
      - No age restrictions
      - No medication validation requirements
      
      **Clinical Context:**
      This register identifies patients with active atrial fibrillation diagnoses for QOF monitoring
      and anticoagulation review. AF is a permanent condition so resolution codes are rare, but
      when present they should be respected (e.g., post-cardioversion normal rhythm).
      
      **QOF Requirements:**
      - AF006: Practice can produce a register of patients with atrial fibrillation
      - Supports indicators for anticoagulation monitoring and stroke risk assessment
      - Links to CHADS-VASc scoring and bleeding risk assessment
      
      **Data Sources:**
      - Diagnosis codes: int_atrial_fibrillation_diagnoses_all (AFIB_COD, AFIBRES_COD cluster IDs)
      - No age filtering required
      
      Includes ALL persons (active, inactive, deceased) for comprehensive reporting.

    config:
      materialized: table
      
    tests:
      - not_null: [person_id]
      - unique: [person_id]
      - accepted_values:
          column_name: is_on_af_register
          values: [true]
      - not_null: 
          column_name: latest_af_diagnosis_date

    columns:
      - name: person_id
        description: "Unique person identifier across the HEI system"
        tests:
          - not_null
          - unique

      - name: age
        description: "Current age of person (no age restrictions for AF register)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 120

      - name: is_on_af_register
        description: "QOF register inclusion flag - TRUE for all persons in this table"
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: earliest_af_diagnosis_date
        description: "Date of first recorded atrial fibrillation diagnosis code (AFIB_COD)"
        tests:
          - dbt_utils.not_accepted_values:
              values: ['1900-01-01']

      - name: latest_af_diagnosis_date
        description: "Date of most recent atrial fibrillation diagnosis code (AFIB_COD)"
        tests:
          - not_null

      - name: latest_af_resolved_date
        description: "Date of most recent AF resolved code (AFIBRES_COD) - NULL if never resolved"

      - name: all_diagnosis_concept_codes
        description: "Array of all AF diagnosis and resolution concept codes recorded for this person"

      - name: all_diagnosis_concept_displays
        description: "Array of all AF diagnosis and resolution concept display terms"

      - name: all_source_cluster_ids
        description: "Array of source cluster IDs (AFIB_COD, AFIBRES_COD) for traceability"

      - name: meets_age_criteria
        description: "Boolean flag: TRUE (no age restrictions for AF register)"
        tests:
          - not_null
          - accepted_values:
              values: [true]

      - name: has_active_diagnosis
        description: "Boolean flag: TRUE if latest diagnosis > latest resolution (or no resolution)"
        tests:
          - not_null
          - accepted_values:
              values: [true] 