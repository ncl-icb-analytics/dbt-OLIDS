version: 2

models:
  - name: stg_flu_code_clusters
    description: "Clinical code cluster definitions for flu programme rules"
    columns:
      - name: rule_group_id
        description: "Rule group identifier (e.g., AST_GROUP, CHD_GROUP)"
        tests:
          - not_null
      - name: cluster_id
        description: "Clinical code cluster identifier"
        tests:
          - not_null
      - name: data_source_type
        description: "Type of data source (observation, medication)"
        tests:
          - not_null
          - accepted_values:
              values: ['observation', 'medication']
      - name: date_qualifier
        description: "How to qualify dates (EARLIEST, LATEST, LATEST_SINCE, LATEST_AFTER)"
        tests:
          - not_null
          - accepted_values:
              values: ['EARLIEST', 'LATEST', 'LATEST_SINCE', 'LATEST_AFTER']
      - name: cluster_description
        description: "Human readable description of the code cluster"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - rule_group_id
            - cluster_id
          name: unique_rule_group_cluster_combination

  - name: stg_flu_campaign_dates
    description: "Campaign-specific dates and lookback periods for flu programme rules"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier or 'ALL' for campaign-wide dates"
        tests:
          - not_null
      - name: date_type
        description: "Type of date (start_dat, ref_dat, child_dat, etc.)"
        tests:
          - not_null
      - name: date_value
        description: "Date value in YYYY-MM-DD format"
        tests:
          - not_null
      - name: description
        description: "Human readable description of the date"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - date_type
          name: unique_campaign_rule_date_combination

  - name: stg_flu_programme_logic
    description: "Business logic and rule types for flu vaccination eligibility"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (e.g., AST_GROUP, CHD_GROUP)"
        tests:
          - not_null
      - name: rule_group_name
        description: "Human readable rule group name"
        tests:
          - not_null
      - name: rule_type
        description: "Type of business rule logic"
        tests:
          - not_null
          - accepted_values:
              values: ['SIMPLE', 'COMBINATION', 'HIERARCHICAL', 'EXCLUSION', 'AGE_BASED', 'AGE_BIRTH_RANGE']
      - name: logic_expression
        description: "Business logic expression for the rule"
      - name: exclusion_groups
        description: "Pipe-separated rule group IDs to exclude"
      - name: age_min_months
        description: "Minimum age in months"
      - name: age_max_years
        description: "Maximum age in years"
      - name: business_description
        description: "Business-friendly description of the rule"
        tests:
          - not_null
      - name: technical_description
        description: "Technical description of the rule implementation"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
          name: unique_campaign_rule_logic_combination

  - name: stg_flu_programme_rules
    description: "Unified flu programme rules configuration combining logic, clusters, and dates"
    columns:
      - name: campaign_id
        description: "Campaign identifier (e.g., flu_2024_25)"
        tests:
          - not_null
      - name: rule_group_id
        description: "Rule group identifier (e.g., AST_GROUP, CHD_GROUP)"
        tests:
          - not_null
      - name: rule_type
        description: "Type of business rule logic"
        tests:
          - not_null
          - accepted_values:
              values: ['SIMPLE', 'COMBINATION', 'HIERARCHICAL', 'EXCLUSION', 'AGE_BASED', 'AGE_BIRTH_RANGE']
      - name: data_source_type
        description: "Type of data source (observation, medication, demographic)"
        tests:
          - accepted_values:
              values: ['observation', 'medication', 'demographic']
      - name: resolved_reference_date
        description: "Resolved reference date for macro usage"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - campaign_id
            - rule_group_id
            - cluster_id
          name: unique_campaign_rule_cluster_combination