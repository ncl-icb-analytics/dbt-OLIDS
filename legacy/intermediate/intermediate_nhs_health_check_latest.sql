CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_NHS_HEALTH_CHECK_LATEST(
    PERSON_ID VARCHAR, -- Unique identifier for the person
    SK_PATIENT_ID VARCHAR, -- Surrogate key for the patient
    CLINICAL_EFFECTIVE_DATE DATE, -- Date the latest NHS Health Check was completed
    CONCEPT_CODE VARCHAR, -- SNOMED code for the NHS Health Check event
    CODE_DESCRIPTION VARCHAR -- Description of the NHS Health Check event
)
TARGET_LAG = '4 hours'
WAREHOUSE = 'NCL_ANALYTICS_XS'
COMMENT = 'Intermediate table containing only the single most recent NHS Health Check completed event for each person, derived from INTERMEDIATE_NHS_HEALTH_CHECK_ALL.'
AS
SELECT
    PERSON_ID,
    SK_PATIENT_ID,
    CLINICAL_EFFECTIVE_DATE,
    CONCEPT_CODE,
    CODE_DESCRIPTION
FROM DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_NHS_HEALTH_CHECK_ALL
QUALIFY ROW_NUMBER() OVER (
    PARTITION BY PERSON_ID
    ORDER BY CLINICAL_EFFECTIVE_DATE DESC
) = 1;
