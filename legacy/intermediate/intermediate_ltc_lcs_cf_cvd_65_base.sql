CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_CF_CVD_65_BASE (
    PERSON_ID VARCHAR,
    SK_PATIENT_ID VARCHAR,
    AGE NUMBER,
    HAS_MODERATE_DOSE_STATIN BOOLEAN,
    HAS_STATIN_ALLERGY BOOLEAN,
    HAS_STATIN_DECISION BOOLEAN,
    LATEST_MODERATE_DOSE_STATIN_DATE DATE,
    LATEST_STATIN_ALLERGY_DATE DATE,
    LATEST_STATIN_DECISION_DATE DATE
)
COMMENT = 'Base population for CVD 65 case finding indicator. Includes patients with QRISK2 ≥ 10 who are not on moderate-dose statins, have no statin allergies/contraindications, and no recent statin decisions.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS
WITH QRISK2Patients AS (
    -- Get patients with QRISK2 ≥ 10
    SELECT DISTINCT
        PERSON_ID,
        SK_PATIENT_ID,
        age.AGE
    FROM DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA r
    JOIN DATA_LAB_OLIDS_UAT.HEI_MIGRATION.DIM_PERSON_AGE age
        USING (PERSON_ID)
    WHERE CLUSTER_ID = 'QRISK2_10YEAR'
        AND RESULT_VALUE >= 10
        AND CLINICAL_EFFECTIVE_DATE = (
            SELECT MAX(CLINICAL_EFFECTIVE_DATE)
            FROM DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
            WHERE PERSON_ID = r.PERSON_ID
                AND CLUSTER_ID = 'QRISK2_10YEAR'
                AND RESULT_VALUE >= 10
        )
),
ModerateDoseStatins AS (
    -- Get patients on moderate-dose statins in last 12 months
    SELECT
        PERSON_ID,
        MAX(CLINICAL_EFFECTIVE_DATE) AS LATEST_MODERATE_DOSE_STATIN_DATE
    FROM DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
    WHERE CLUSTER_ID = 'STATIN_CVD_65_MEDICATIONS'
        AND CLINICAL_EFFECTIVE_DATE >= ADD_MONTHS(CURRENT_DATE(), -12)
    GROUP BY PERSON_ID
),
StatinAllergies AS (
    -- Get patients with statin allergies or contraindications
    SELECT
        PERSON_ID,
        MAX(CLINICAL_EFFECTIVE_DATE) AS LATEST_STATIN_ALLERGY_DATE
    FROM DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
    WHERE CLUSTER_ID IN ('STATIN_ALLERGY_ADVERSE_REACTION', 'STATIN_NOT_INDICATED')
    GROUP BY PERSON_ID
),
StatinDecisions AS (
    -- Get patients with statin decisions in last 60 months
    SELECT
        PERSON_ID,
        MAX(CLINICAL_EFFECTIVE_DATE) AS LATEST_STATIN_DECISION_DATE
    FROM DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
    WHERE CLUSTER_ID = 'STATINDEC_COD'
        AND CLINICAL_EFFECTIVE_DATE >= ADD_MONTHS(CURRENT_DATE(), -60)
    GROUP BY PERSON_ID
)
-- Final selection
SELECT
    qp.PERSON_ID,
    qp.SK_PATIENT_ID,
    qp.AGE,
    COALESCE(mds.PERSON_ID IS NOT NULL, FALSE) AS HAS_MODERATE_DOSE_STATIN,
    COALESCE(sa.PERSON_ID IS NOT NULL, FALSE) AS HAS_STATIN_ALLERGY,
    COALESCE(sd.PERSON_ID IS NOT NULL, FALSE) AS HAS_STATIN_DECISION,
    mds.LATEST_MODERATE_DOSE_STATIN_DATE,
    sa.LATEST_STATIN_ALLERGY_DATE,
    sd.LATEST_STATIN_DECISION_DATE
FROM QRISK2Patients qp
LEFT JOIN ModerateDoseStatins mds
    USING (PERSON_ID)
LEFT JOIN StatinAllergies sa
    USING (PERSON_ID)
LEFT JOIN StatinDecisions sd
    USING (PERSON_ID)
WHERE NOT COALESCE(mds.PERSON_ID IS NOT NULL, FALSE)  -- Not on moderate-dose statins
    AND NOT COALESCE(sa.PERSON_ID IS NOT NULL, FALSE)  -- No statin allergies
    AND NOT COALESCE(sd.PERSON_ID IS NOT NULL, FALSE);  -- No statin decisions
