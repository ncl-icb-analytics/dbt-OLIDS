CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_HF_DETAILS (
    PERSON_ID VARCHAR,
    SK_PATIENT_ID VARCHAR,
    AGE NUMBER,

    EARLIEST_HF_DIAGNOSIS_DATE DATE,
    LATEST_HF_DIAGNOSIS_DATE DATE,
    RAW_LATEST_HF_RESOLVED_DATE DATE, -- Latest HFRES_COD date, regardless of HF_COD dates

    EARLIEST_HFLVSD_DIAGNOSIS_DATE DATE,
    LATEST_HFLVSD_DIAGNOSIS_DATE DATE,

    EARLIEST_REDUCED_EF_DIAGNOSIS_DATE DATE,
    LATEST_REDUCED_EF_DIAGNOSIS_DATE DATE,

    ALL_HF_CONCEPT_CODES ARRAY,
    ALL_HF_CONCEPT_DISPLAYS ARRAY,
    ALL_HFRES_CONCEPT_CODES ARRAY,
    ALL_HFRES_CONCEPT_DISPLAYS ARRAY,
    ALL_HFLVSD_CONCEPT_CODES ARRAY,
    ALL_HFLVSD_CONCEPT_DISPLAYS ARRAY,
    ALL_REDEJCFRAC_CONCEPT_CODES ARRAY,
    ALL_REDEJCFRAC_CONCEPT_DISPLAYS ARRAY
)
COMMENT = 'Intermediate table aggregating Heart Failure related diagnoses (HF, HFRES, HFLVSD, REDEJCFRAC) for each person.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS

WITH BaseObservations AS (
    -- Get all diagnoses related to HF, HF Resolved, HFLVSD, and Reduced Ejection Fraction
    SELECT
        PP."person_id" AS PERSON_ID,
        P."sk_patient_id" AS SK_PATIENT_ID,
        AGE.AGE,
        O."clinical_effective_date"::DATE AS CLINICAL_EFFECTIVE_DATE,
        MC.CONCEPT_CODE,
        MC.CODE_DESCRIPTION,
        MC.CLUSTER_ID
    FROM "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."OBSERVATION" AS O
    JOIN DATA_LAB_NCL_TRAINING_TEMP.CODESETS.MAPPED_CONCEPTS AS MC
        ON O."observation_core_concept_id" = MC.SOURCE_CODE_ID
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT_PERSON" AS PP
        ON O."patient_id" = PP."patient_id"
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT" AS P
        ON O."patient_id" = P."id"
    JOIN DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.DIM_PERSON_AGE AS AGE
        ON PP."person_id" = AGE.PERSON_ID
    WHERE MC.CLUSTER_ID IN ('HF_COD', 'HFRES_COD', 'HFLVSD_COD', 'REDEJCFRAC_COD')
)
SELECT
    PERSON_ID,
    SK_PATIENT_ID,
    AGE,
    MIN(CASE WHEN CLUSTER_ID = 'HF_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_HF_DIAGNOSIS_DATE,
    MAX(CASE WHEN CLUSTER_ID = 'HF_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS LATEST_HF_DIAGNOSIS_DATE,

    MAX(CASE WHEN CLUSTER_ID = 'HFRES_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS RAW_LATEST_HF_RESOLVED_DATE,

    MIN(CASE WHEN CLUSTER_ID = 'HFLVSD_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_HFLVSD_DIAGNOSIS_DATE,
    MAX(CASE WHEN CLUSTER_ID = 'HFLVSD_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS LATEST_HFLVSD_DIAGNOSIS_DATE,

    MIN(CASE WHEN CLUSTER_ID = 'REDEJCFRAC_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_REDUCED_EF_DIAGNOSIS_DATE,
    MAX(CASE WHEN CLUSTER_ID = 'REDEJCFRAC_COD' THEN CLINICAL_EFFECTIVE_DATE END) AS LATEST_REDUCED_EF_DIAGNOSIS_DATE,

    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HF_COD' THEN CONCEPT_CODE END) AS ALL_HF_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HF_COD' THEN CODE_DESCRIPTION END) AS ALL_HF_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HFRES_COD' THEN CONCEPT_CODE END) AS ALL_HFRES_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HFRES_COD' THEN CODE_DESCRIPTION END) AS ALL_HFRES_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HFLVSD_COD' THEN CONCEPT_CODE END) AS ALL_HFLVSD_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'HFLVSD_COD' THEN CODE_DESCRIPTION END) AS ALL_HFLVSD_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'REDEJCFRAC_COD' THEN CONCEPT_CODE END) AS ALL_REDEJCFRAC_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN CLUSTER_ID = 'REDEJCFRAC_COD' THEN CODE_DESCRIPTION END) AS ALL_REDEJCFRAC_CONCEPT_DISPLAYS
FROM BaseObservations
GROUP BY PERSON_ID, SK_PATIENT_ID, AGE;
