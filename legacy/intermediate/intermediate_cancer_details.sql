CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_OLIDS_UAT.HEI_MIGRATION.INTERMEDIATE_CANCER_DETAILS (
    PERSON_ID VARCHAR, -- Unique identifier for the person
    SK_PATIENT_ID VARCHAR, -- Surrogate key for the patient
    AGE NUMBER, -- Age of the person

    EARLIEST_CANCER_DATE DATE, -- Earliest cancer diagnosis date
    LATEST_CANCER_DATE DATE, -- Latest cancer diagnosis date (CAN_DAT)

    EARLIEST_REVIEW_DATE DATE, -- Earliest cancer care review date
    LATEST_REVIEW_DATE DATE, -- Latest cancer care review date

    EARLIEST_INVITE_DATE DATE, -- Earliest cancer care review invitation date
    SECOND_INVITE_DATE DATE, -- Second cancer care review invitation date (at least 7 days after first)

    LATEST_PCA_DECLINE_DATE DATE, -- Latest date patient declined cancer care
    LATEST_PCA_UNSUITABLE_DATE DATE, -- Latest date cancer care was deemed unsuitable
    LATEST_PCA_SUPPORT_DATE DATE, -- Latest date cancer support services information provided

    ALL_CANCER_CONCEPT_CODES ARRAY, -- All cancer concept codes
    ALL_CANCER_CONCEPT_DISPLAYS ARRAY, -- All cancer concept display terms
    ALL_CANCER_REVIEW_CONCEPT_CODES ARRAY, -- All cancer review concept codes
    ALL_CANCER_REVIEW_CONCEPT_DISPLAYS ARRAY, -- All cancer review concept display terms
    ALL_CANCER_INVITE_CONCEPT_CODES ARRAY, -- All cancer invite concept codes
    ALL_CANCER_INVITE_CONCEPT_DISPLAYS ARRAY, -- All cancer invite concept display terms
    ALL_CANCER_PCA_DECLINE_CONCEPT_CODES ARRAY, -- All cancer PCA decline concept codes
    ALL_CANCER_PCA_DECLINE_CONCEPT_DISPLAYS ARRAY, -- All cancer PCA decline concept display terms
    ALL_CANCER_PCA_UNSUITABLE_CONCEPT_CODES ARRAY, -- All cancer PCA unsuitable concept codes
    ALL_CANCER_PCA_UNSUITABLE_CONCEPT_DISPLAYS ARRAY, -- All cancer PCA unsuitable concept display terms
    ALL_CANCER_PCA_SUPPORT_CONCEPT_CODES ARRAY, -- All cancer PCA support concept codes
    ALL_CANCER_PCA_SUPPORT_CONCEPT_DISPLAYS ARRAY -- All cancer PCA support concept display terms
)
COMMENT = 'Intermediate table aggregating Cancer related diagnoses (CAN_COD, MDRV_COD, CANINVITE_COD, CANPCADEC_COD, CANPCAPU_COD, CANPCSUPP_COD) for each person.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS

WITH BaseObservations AS (
    -- Get all diagnoses related to Cancer, Reviews, Invites, and PCA decisions
    SELECT
        PP."person_id" AS PERSON_ID,
        P."sk_patient_id" AS SK_PATIENT_ID,
        AGE.AGE,
        O."clinical_effective_date"::DATE AS CLINICAL_EFFECTIVE_DATE,
        MC.CONCEPT_CODE,
        MC.CODE_DESCRIPTION,
        MC.CLUSTER_ID
    FROM "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."OBSERVATION" AS O
    JOIN DATA_LAB_OLIDS_UAT.REFERENCE.MAPPED_CONCEPTS AS MC
        ON O."observation_core_concept_id" = MC.SOURCE_CODE_ID
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT_PERSON" AS PP
        ON O."patient_id" = PP."patient_id"
    JOIN "Data_Store_OLIDS_Dummy"."OLIDS_MASKED"."PATIENT" AS P
        ON O."patient_id" = P."id"
    JOIN DATA_LAB_OLIDS_UAT.HEI_MIGRATION.DIM_PERSON_AGE AS AGE
        ON PP."person_id" = AGE.PERSON_ID
    WHERE MC.CLUSTER_ID IN ('CAN_COD', 'MDRV_COD', 'CANINVITE_COD', 'CANPCADEC_COD', 'CANPCAPU_COD', 'CANPCSUPP_COD')
),
InviteDates AS (
    -- Calculate first invite date
    SELECT
        PERSON_ID,
        MIN(CLINICAL_EFFECTIVE_DATE) AS FIRST_INVITE_DATE
    FROM BaseObservations
    WHERE CLUSTER_ID = 'CANINVITE_COD'
    GROUP BY PERSON_ID
),
SecondInvite AS (
    -- Calculate second invite date (at least 7 days after first)
    SELECT
        bo.PERSON_ID,
        MIN(bo.CLINICAL_EFFECTIVE_DATE) AS SECOND_INVITE_DATE
    FROM BaseObservations bo
    JOIN InviteDates id
      ON bo.PERSON_ID = id.PERSON_ID
     AND bo.CLUSTER_ID = 'CANINVITE_COD'
     AND bo.CLINICAL_EFFECTIVE_DATE > DATEADD(day, 7, id.FIRST_INVITE_DATE)
    GROUP BY bo.PERSON_ID
)
SELECT
    bo.PERSON_ID,
    bo.SK_PATIENT_ID,
    bo.AGE,

    -- Cancer diagnosis dates
    MIN(CASE WHEN bo.CLUSTER_ID = 'CAN_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_CANCER_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'CAN_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_CANCER_DATE,

    -- Review dates
    MIN(CASE WHEN bo.CLUSTER_ID = 'MDRV_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS EARLIEST_REVIEW_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'MDRV_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_REVIEW_DATE,

    -- Invite dates
    id.FIRST_INVITE_DATE AS EARLIEST_INVITE_DATE,
    si.SECOND_INVITE_DATE AS SECOND_INVITE_DATE,

    -- PCA decision dates
    MAX(CASE WHEN bo.CLUSTER_ID = 'CANPCADEC_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_PCA_DECLINE_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'CANPCAPU_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_PCA_UNSUITABLE_DATE,
    MAX(CASE WHEN bo.CLUSTER_ID = 'CANPCSUPP_COD' THEN bo.CLINICAL_EFFECTIVE_DATE END) AS LATEST_PCA_SUPPORT_DATE,

    -- Concept code arrays
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CAN_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CAN_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'MDRV_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_REVIEW_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'MDRV_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_REVIEW_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANINVITE_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_INVITE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANINVITE_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_INVITE_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCADEC_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_PCA_DECLINE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCADEC_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_PCA_DECLINE_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCAPU_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_PCA_UNSUITABLE_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCAPU_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_PCA_UNSUITABLE_CONCEPT_DISPLAYS,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCSUPP_COD' THEN bo.CONCEPT_CODE END) AS ALL_CANCER_PCA_SUPPORT_CONCEPT_CODES,
    ARRAY_AGG(DISTINCT CASE WHEN bo.CLUSTER_ID = 'CANPCSUPP_COD' THEN bo.CODE_DESCRIPTION END) AS ALL_CANCER_PCA_SUPPORT_CONCEPT_DISPLAYS
FROM BaseObservations bo
LEFT JOIN InviteDates id ON bo.PERSON_ID = id.PERSON_ID
LEFT JOIN SecondInvite si ON bo.PERSON_ID = si.PERSON_ID
GROUP BY
    bo.PERSON_ID,
    bo.SK_PATIENT_ID,
    bo.AGE,
    id.FIRST_INVITE_DATE,
    si.SECOND_INVITE_DATE;
