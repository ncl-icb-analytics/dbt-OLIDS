CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_CF_HEALTH_CHECKS (
    PERSON_ID,
    LATEST_HEALTH_CHECK_DATE,
    HAS_RECENT_HEALTH_CHECK_24M,
    HAS_RECENT_HEALTH_CHECK_12M
)
COMMENT = 'Reusable health check dates and flags for LTC LCS case finding indicators.'
TARGET_LAG = '4 hours'
REFRESH_MODE = AUTO
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS
SELECT
    PERSON_ID,
    MAX(CLINICAL_EFFECTIVE_DATE) AS LATEST_HEALTH_CHECK_DATE,
    -- Common exclusion flags
    CASE WHEN MAX(CLINICAL_EFFECTIVE_DATE) >= DATEADD(month, -24, CURRENT_DATE()) 
         THEN TRUE ELSE FALSE END AS HAS_RECENT_HEALTH_CHECK_24M,
    CASE WHEN MAX(CLINICAL_EFFECTIVE_DATE) >= DATEADD(month, -12, CURRENT_DATE()) 
         THEN TRUE ELSE FALSE END AS HAS_RECENT_HEALTH_CHECK_12M
FROM DATA_LAB_NCL_TRAINING_TEMP.HEI_MIGRATION.INTERMEDIATE_LTC_LCS_RAW_DATA
WHERE CLUSTER_ID = 'HEALTH_CHECK_COMP'
GROUP BY PERSON_ID; 