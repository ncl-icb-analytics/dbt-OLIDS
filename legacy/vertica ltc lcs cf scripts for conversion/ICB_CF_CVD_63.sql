WITH NON_HDL_CHOL_EMIS AS (
    SELECT 
        EMPI_ID, 
        RESULT_CODE,
        SERVICE_DATE,
        NORM_NUMERIC_VALUE,
        ROW_NUMBER() OVER (PARTITION BY EMPI_ID ORDER BY SERVICE_DATE DESC) as rn
    FROM PH_F_RESULT
    WHERE RESULT_CODE IN (
        SELECT SNOMED_CODE
        FROM JOINED_LTC_LOOKUP
        WHERE CLUSTER_ID = 'NON_HDL_CHOL'
    )
    AND SOURCE_DESCRIPTION = 'EMIS GP'
    AND SERVICE_DATE < NOW()
),
STAT_COD_EMIS AS (
    SELECT EMPI_ID
    FROM CERNER_MEDICATION_JOINED_TABLE
    WHERE DRUG_CODE IN ('112151000001105','4172511000001104','4172611000001100','16201611000001109','16507511000001107','33557011000001103','20577611000001105','22941511000001103','37039111000001102','20495411000001101','41140311000001103','20492611000001107','20573911000001108','20497611000001105','41499211000001109','35364311000001108','20570911000001100','29772911000001101','41958611000001107','36566911000001102','20508511000001100','36491811000001107','22613511000001107','32395211000001103','36954811000001101','20483311000001108','39733211000001101','13923311000001102','20979511000001106','22047911000001109','37568411000001107','20513411000001108','38801211000001105','40679611000001107','35136611000001109','756111000001109','22202511000001100','20982911000001100','41620211000001107','21779811000001108','134489001','4171311000001101','4172111000001108','37611611000001108','14212311000001103','40849211000001100','41222911000001102','35039711000001102','35036111000001106','35027811000001104','36500111000001102','41165211000001107','13858311000001102','18228811000001101','36732311000001105','41964411000001108','11580111000001101','35042411000001101','35652011000001104','39241111000001103','35019611000001101','35034611000001107','4171311000001101','37798511000001109','36238011000001103','408037007','39480411000001109','19870211000001107','35032111000001107','13110811000001105','41475811000001103','10513311000001102','34954211000001108','35028211000001101','35184211000001108','17500811000001107','34954611000001105','18229111000001101','35652211000001109','4172111000001108','36500311000001100','13858511000001108','35028011000001106','10513711000001103','35041611000001109','16155011000001105','35032311000001109','35028411000001102','35018711000001101','41223611000001103','41964611000001106','36238211000001108','408024009','37798711000001104','35036311000001108','37611811000001107','17339611000001106','35184411000001107','36734011000001101','41475511000001101','40848711000001103','39480611000001107','35035011000001101','41165411000001106','39241311000001101','35039911000001100','756111000001109')
    --  SELECT SNOMED_CODE
    --  FROM JOINED_LTC_LOOKUP
    --  WHERE CLUSTER_ID IN ('STAT_COD')
    AND START_DT_TM >= ADD_MONTHS(CURRENT_DATE(),-6)
    AND START_DT_TM < NOW()
    AND SOURCE_DESCRIPTION = 'EMIS GP'
),
NON_HDL_CHOL AS (
    SELECT 
        EMPI_ID, 
        RESULT_CODE,
        SERVICE_DATE,
        NORM_NUMERIC_VALUE,
        ROW_NUMBER() OVER (PARTITION BY EMPI_ID ORDER BY SERVICE_DATE DESC) as rn
    FROM PH_F_RESULT
    WHERE RESULT_CODE IN (
        SELECT SNOMED_CODE
        FROM JOINED_LTC_LOOKUP
        WHERE CLUSTER_ID = 'NON_HDL_CHOL'
    )
    AND SERVICE_DATE < NOW()
),
STAT_COD AS (
    SELECT EMPI_ID
    FROM CERNER_MEDICATION_JOINED_TABLE
    WHERE DRUG_CODE IN ('112151000001105','4172511000001104','4172611000001100','16201611000001109','16507511000001107','33557011000001103','20577611000001105','22941511000001103','37039111000001102','20495411000001101','41140311000001103','20492611000001107','20573911000001108','20497611000001105','41499211000001109','35364311000001108','20570911000001100','29772911000001101','41958611000001107','36566911000001102','20508511000001100','36491811000001107','22613511000001107','32395211000001103','36954811000001101','20483311000001108','39733211000001101','13923311000001102','20979511000001106','22047911000001109','37568411000001107','20513411000001108','38801211000001105','40679611000001107','35136611000001109','756111000001109','22202511000001100','20982911000001100','41620211000001107','21779811000001108','134489001','4171311000001101','4172111000001108','37611611000001108','14212311000001103','40849211000001100','41222911000001102','35039711000001102','35036111000001106','35027811000001104','36500111000001102','41165211000001107','13858311000001102','18228811000001101','36732311000001105','41964411000001108','11580111000001101','35042411000001101','35652011000001104','39241111000001103','35019611000001101','35034611000001107','4171311000001101','37798511000001109','36238011000001103','408037007','39480411000001109','19870211000001107','35032111000001107','13110811000001105','41475811000001103','10513311000001102','34954211000001108','35028211000001101','35184211000001108','17500811000001107','34954611000001105','18229111000001101','35652211000001109','4172111000001108','36500311000001100','13858511000001108','35028011000001106','10513711000001103','35041611000001109','16155011000001105','35032311000001109','35028411000001102','35018711000001101','41223611000001103','41964611000001106','36238211000001108','408024009','37798711000001104','35036311000001108','37611811000001107','17339611000001106','35184411000001107','36734011000001101','41475511000001101','40848711000001103','39480611000001107','35035011000001101','41165411000001106','39241311000001101','35039911000001100','756111000001109')
    --  SELECT SNOMED_CODE
    --  FROM JOINED_LTC_LOOKUP
    --  WHERE CLUSTER_ID IN ('STAT_COD')
    AND START_DT_TM >= ADD_MONTHS(CURRENT_DATE(),-6)
    AND START_DT_TM < NOW()
),
OTHER AS (
    SELECT DISTINCT ICB_CF_CVD_63_BASE.EMPI_ID
    FROM ICB_CF_CVD_63_BASE
    INNER JOIN NON_HDL_CHOL USING (EMPI_ID)
    INNER JOIN STAT_COD USING (EMPI_ID)
    WHERE rn = 1 AND NORM_NUMERIC_VALUE > 2.5
),
EMIS AS (
    SELECT DISTINCT ICB_CF_CVD_63_BASE.EMPI_ID
    FROM ICB_CF_CVD_63_BASE
    INNER JOIN NON_HDL_CHOL_EMIS USING (EMPI_ID)
    INNER JOIN STAT_COD_EMIS USING (EMPI_ID)
    WHERE rn = 1 AND NORM_NUMERIC_VALUE > 2.5
    AND SOURCE = 'EMIS'
)
SELECT 
    COALESCE (EMIS.EMPI_ID, OTHER.EMPI_ID) as EMPI_ID,
    CASE 
        WHEN EMIS.EMPI_ID IS NOT NULL THEN 'EMIS' 
        ELSE 'OTHER' 
    END AS Source
FROM (
    SELECT EMPI_ID FROM OTHER
    UNION
    SELECT EMPI_ID FROM EMIS
) AS subquery
LEFT JOIN EMIS ON subquery.EMPI_ID = EMIS.EMPI_ID
LEFT JOIN OTHER ON subquery.EMPI_ID = OTHER.EMPI_ID